import * as tslib_1 from "tslib";
import { map } from 'rxjs/operators';
import { Injectable, EventEmitter, Output } from '@angular/core';
import { HttpClient } from '@angular/common/http';
import { NSystemService } from './n-system.service';
import { NTokenService } from './n-token.service';
import { NPubSubService } from './n-pubSub.service';
import { NSessionStorageService } from './n-sessionStorage.service';
import { NLocalStorageService } from './n-localStorage.service';
import { NNotificationService } from './n-notification.service';
var NLoginService = /** @class */ (function () {
    function NLoginService(http, pubSubService, notificationService, nLocalStorageService, nTokenService) {
        this.http = http;
        this.pubSubService = pubSubService;
        this.notificationService = notificationService;
        this.nLocalStorageService = nLocalStorageService;
        this.nTokenService = nTokenService;
        this.loginCompleted = new EventEmitter();
        this.systemService = NSystemService.getInstance();
        // this.nTokenService = new NTokenService();
        this.nSessionStorage = new NSessionStorageService();
        // this.nLocalStorageService = new NLocalStorageService();
    }
    NLoginService.prototype.login = function (userName, password, isRemember) {
        var _this = this;
        this.appProperties = this.systemService.getVal('properties');
        this.loginUrl = this.systemService.getAuthUrl() + this.appProperties.appName;
        this.uuid = this.nLocalStorageService.getValue('uuid');
        if (!this.uuid) {
            this.uuid = this.nLocalStorageService.checkDeviceId();
        }
        this.details = {
            username: userName,
            password: password,
        };
        this.details.platformDetails = this.systemService.getPlatformDetails(this.systemService.checkDevice());
        this.details.platformDetails['uuid'] = this.uuid;
        return this.http.post(this.loginUrl, JSON.stringify(this.details)).pipe(map(function (result) {
            var tokensObj = result;
            if (tokensObj) {
                _this.nTokenService.updateTokens(tokensObj, isRemember);
            }
            // TODO chris array of supported pushes currently only support APNS and Firebase
            if ((_this.systemService.getVal('firebaseSenderId') != 'FIREBASE_SENDER_ID' && _this.systemService.getVal('firebaseAuthKey') != 'FIREBASE_AUTH_KEY')
                || (_this.systemService.getVal('pushType') === 'APNS' && _this.systemService.isIOS())) {
                _this.pubSubService.$pub('firebaseRegister');
            }
            _this.pubSubService.$pub('loginComplete');
            return (result);
        }, function (error) {
            return (error);
        }));
    };
    NLoginService.prototype.isLoggedIn = function () {
        var _this = this;
        return this.nLocalStorageService.initStorage().then(function (result) {
            if (_this.nSessionStorage.getValue('accessToken') && _this.nSessionStorage.getValue('refreshToken') &&
                _this.nSessionStorage.getValue('accessToken') != 'null' && _this.nSessionStorage.getValue('refreshToken') != 'null') {
                return true;
            }
            return false;
        }).catch(function (error) {
            return false;
        });
    };
    tslib_1.__decorate([
        Output(),
        tslib_1.__metadata("design:type", Object)
    ], NLoginService.prototype, "loginCompleted", void 0);
    NLoginService = tslib_1.__decorate([
        Injectable(),
        tslib_1.__metadata("design:paramtypes", [HttpClient, NPubSubService, NNotificationService,
            NLocalStorageService, NTokenService])
    ], NLoginService);
    return NLoginService;
}());
export { NLoginService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibi1sb2dpbi5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vbmV1dHJpbm9zLXNlZWQtc2VydmljZXMvIiwic291cmNlcyI6WyJzcmMvYXBwL25ldXRyaW5vcy1zZWVkLXNlcnZpY2VzL24tbG9naW4uc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQ0EsT0FBTyxFQUFDLEdBQUcsRUFBQyxNQUFNLGdCQUFnQixDQUFDO0FBQ25DLE9BQU8sRUFBRSxVQUFVLEVBQUUsWUFBWSxFQUFFLE1BQU0sRUFBWSxNQUFNLGVBQWUsQ0FBQztBQUMzRSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFDbEQsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBQ3BELE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUNsRCxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDcEQsT0FBTyxFQUFFLHNCQUFzQixFQUFFLE1BQU0sNEJBQTRCLENBQUM7QUFDcEUsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sMEJBQTBCLENBQUM7QUFDaEUsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sMEJBQTBCLENBQUM7QUFNaEU7SUFTRSx1QkFBb0IsSUFBZ0IsRUFBVSxhQUE2QixFQUFVLG1CQUF5QyxFQUNwSCxvQkFBMEMsRUFBVSxhQUE0QjtRQUR0RSxTQUFJLEdBQUosSUFBSSxDQUFZO1FBQVUsa0JBQWEsR0FBYixhQUFhLENBQWdCO1FBQVUsd0JBQW1CLEdBQW5CLG1CQUFtQixDQUFzQjtRQUNwSCx5QkFBb0IsR0FBcEIsb0JBQW9CLENBQXNCO1FBQVUsa0JBQWEsR0FBYixhQUFhLENBQWU7UUFGaEYsbUJBQWMsR0FBRyxJQUFJLFlBQVksRUFBRSxDQUFDO1FBRzVDLElBQUksQ0FBQyxhQUFhLEdBQUcsY0FBYyxDQUFDLFdBQVcsRUFBRSxDQUFDO1FBQ2xELDRDQUE0QztR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QUNiO1lBQ0QsT0FBTyxLQUFLLENBQUM7UUFDZixDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsVUFBQSxLQUFLO1lBQ1osT0FBTyxLQUFLLENBQUM7UUFDZixDQUFDLENBQUMsQ0FBQztJQUVMLENBQUM7SUFuRFM7UUFBVCxNQUFNLEVBQUU7O3lEQUFxQztJQVJuQyxhQUFhO1FBRHpCLFVBQVUsRUFBRTtpREFVZSxVQUFVLEVBQXlCLGNBQWMsRUFBK0Isb0JBQW9CO1lBQzlGLG9CQUFvQixFQUF5QixhQUFhO09BVi9FLGFBQWEsQ0E0RHpCO0lBQUQsb0JBQUM7Q0FBQSxBQTVERCxJQTREQztTQTVEWSxhQUFhIiwic291cmNlc0NvbnRlbnQiOlsiXG5pbXBvcnQge21hcH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgSW5qZWN0YWJsZSwgRXZlbnRFbWl0dGVyLCBPdXRwdXQsIEluamVjdG9yIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBIdHRwQ2xpZW50IH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uL2h0dHAnO1xuaW1wb3J0IHsgTlN5c3RlbVNlcnZpY2UgfSBmcm9tICcuL24tc3lzdGVtLnNlcnZpY2UnO1xuaW1wb3J0IHsgTlRva2VuU2VydmljZSB9IGZyb20gJy4vbi10b2tlbi5zZXJ2aWNlJztcbmltcG9ydCB7IE5QdWJTdWJTZXJ2aWNlIH0gZnJvbSAnLi9uLXB1YlN1Yi5zZXJ2aWNlJztcbmltcG9ydCB7IE5TZXNzaW9uU3RvcmFnZVNlcnZpY2UgfSBmcm9tICcuL24tc2Vzc2lvblN0b3JhZ2Uuc2VydmljZSc7XG5pbXBvcnQgeyBOTG9jYWxTdG9yYWdlU2VydmljZSB9IGZyb20gJy4vbi1sb2NhbFN0b3JhZ2Uuc2VydmljZSc7XG5pbXBvcnQgeyBOTm90aWZpY2F0aW9uU2VydmljZSB9IGZyb20gJy4vbi1ub3RpZmljYXRpb24uc2VydmljZSc7XG5cbmltcG9ydCB7IE9ic2VydmFibGUgfSBmcm9tICdyeGpzJztcblxuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgTkxvZ2luU2VydmljZSB7XG4gIGxvZ2luVXJsO1xuICBhcHBQcm9wZXJ0aWVzO1xuICBzeXN0ZW1TZXJ2aWNlO1xuICBuU2Vzc2lvblN0b3JhZ2U7XG4gIHV1aWQ7XG4gIGRldGFpbHM6IGFueTtcblxuICBAT3V0cHV0KCkgbG9naW5Db21wbGV0ZWQgPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgaHR0cDogSHR0cENsaWVudCwgcHJpdmF0ZSBwdWJTdWJTZXJ2aWNlOiBOUHViU3ViU2VydmljZSwgcHJpdmF0ZSBub3RpZmljYXRpb25TZXJ2aWNlOiBOTm90aWZpY2F0aW9uU2VydmljZSxcbiAgICBwcml2YXRlIG5Mb2NhbFN0b3JhZ2VTZXJ2aWNlOiBOTG9jYWxTdG9yYWdlU2VydmljZSwgcHJpdmF0ZSBuVG9rZW5TZXJ2aWNlOiBOVG9rZW5TZXJ2aWNlKSB7XG4gICAgdGhpcy5zeXN0ZW1TZXJ2aWNlID0gTlN5c3RlbVNlcnZpY2UuZ2V0SW5zdGFuY2UoKTtcbiAgICAvLyB0aGlzLm5Ub2tlblNlcnZpY2UgPSBuZXcgTlRva2VuU2VydmljZSgpO1xuICAgIHRoaXMublNlc3Npb25TdG9yYWdlID0gbmV3IE5TZXNzaW9uU3RvcmFnZVNlcnZpY2UoKTtcbiAgICAvLyB0aGlzLm5Mb2NhbFN0b3JhZ2VTZXJ2aWNlID0gbmV3IE5Mb2NhbFN0b3JhZ2VTZXJ2aWNlKCk7XG4gIH1cblxuXG4gIGxvZ2luKHVzZXJOYW1lLCBwYXNzd29yZCwgaXNSZW1lbWJlcj8pIHtcbiAgICB0aGlzLmFwcFByb3BlcnRpZXMgPSB0aGlzLnN5c3RlbVNlcnZpY2UuZ2V0VmFsKCdwcm9wZXJ0aWVzJyk7XG4gICAgdGhpcy5sb2dpblVybCA9IHRoaXMuc3lzdGVtU2VydmljZS5nZXRBdXRoVXJsKCkgKyB0aGlzLmFwcFByb3BlcnRpZXMuYXBwTmFtZTtcbiAgICB0aGlzLnV1aWQgPSB0aGlzLm5Mb2NhbFN0b3JhZ2VTZXJ2aWNlLmdldFZhbHVlKCd1dWlkJyk7XG4gICAgaWYgKCF0aGlzLnV1aWQpIHtcbiAgICAgIHRoaXMudXVpZCA9IHRoaXMubkxvY2FsU3RvcmFnZVNlcnZpY2UuY2hlY2tEZXZpY2VJZCgpO1xuICAgIH1cbiAgICB0aGlzLmRldGFpbHMgPSB7XG4gICAgICB1c2VybmFtZTogdXNlck5hbWUsXG4gICAgICBwYXNzd29yZDogcGFzc3dvcmQsXG4gICAgfTtcbiAgICB0aGlzLmRldGFpbHMucGxhdGZvcm1EZXRhaWxzID0gdGhpcy5zeXN0ZW1TZXJ2aWNlLmdldFBsYXRmb3JtRGV0YWlscyh0aGlzLnN5c3RlbVNlcnZpY2UuY2hlY2tEZXZpY2UoKSk7XG4gICAgdGhpcy5kZXRhaWxzLnBsYXRmb3JtRGV0YWlsc1sndXVpZCddID0gdGhpcy51dWlkO1xuICAgIHJldHVybiB0aGlzLmh0dHAucG9zdCh0aGlzLmxvZ2luVXJsLCBKU09OLnN0cmluZ2lmeSh0aGlzLmRldGFpbHMpKS5waXBlKG1hcChyZXN1bHQgPT4ge1xuICAgICAgY29uc3QgdG9rZW5zT2JqID0gcmVzdWx0O1xuICAgICAgaWYgKHRva2Vuc09iaikge1xuICAgICAgICB0aGlzLm5Ub2tlblNlcnZpY2UudXBkYXRlVG9rZW5zKHRva2Vuc09iaiwgaXNSZW1lbWJlcik7XG4gICAgICB9XG4gICAgICAvLyBUT0RPIGNocmlzIGFycmF5IG9mIHN1cHBvcnRlZCBwdXNoZXMgY3VycmVudGx5IG9ubHkgc3VwcG9ydCBBUE5TIGFuZCBGaXJlYmFzZVxuICAgICAgaWYgKCh0aGlzLnN5c3RlbVNlcnZpY2UuZ2V0VmFsKCdmaXJlYmFzZVNlbmRlcklkJykgIT0gJ0ZJUkVCQVNFX1NFTkRFUl9JRCcgJiYgdGhpcy5zeXN0ZW1TZXJ2aWNlLmdldFZhbCgnZmlyZWJhc2VBdXRoS2V5JykgIT0gJ0ZJUkVCQVNFX0FVVEhfS0VZJykgXG4gICAgICAgICAgIHx8ICh0aGlzLnN5c3RlbVNlcnZpY2UuZ2V0VmFsKCdwdXNoVHlwZScpID09PSAnQVBOUycgJiYgdGhpcy5zeXN0ZW1TZXJ2aWNlLmlzSU9TKCkpKSB7XG4gICAgICAgIHRoaXMucHViU3ViU2VydmljZS4kcHViKCdmaXJlYmFzZVJlZ2lzdGVyJyk7XG4gICAgICB9XG4gICAgICB0aGlzLnB1YlN1YlNlcnZpY2UuJHB1YignbG9naW5Db21wbGV0ZScpO1xuICAgICAgcmV0dXJuIChyZXN1bHQpO1xuICAgIH0sIGVycm9yID0+IHtcbiAgICAgIHJldHVybiAoZXJyb3IpO1xuICAgIH0pKTtcbiAgfVxuXG4gIGlzTG9nZ2VkSW4oKSB7XG4gICAgcmV0dXJuIHRoaXMubkxvY2FsU3RvcmFnZVNlcnZpY2UuaW5pdFN0b3JhZ2UoKS50aGVuKHJlc3VsdCA9PiB7XG4gICAgICBpZiAodGhpcy5uU2Vzc2lvblN0b3JhZ2UuZ2V0VmFsdWUoJ2FjY2Vzc1Rva2VuJykgJiYgdGhpcy5uU2Vzc2lvblN0b3JhZ2UuZ2V0VmFsdWUoJ3JlZnJlc2hUb2tlbicpICYmXG4gICAgICAgIHRoaXMublNlc3Npb25TdG9yYWdlLmdldFZhbHVlKCdhY2Nlc3NUb2tlbicpICE9ICdudWxsJyAmJiB0aGlzLm5TZXNzaW9uU3RvcmFnZS5nZXRWYWx1ZSgncmVmcmVzaFRva2VuJykgIT0gJ251bGwnKSB7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgfVxuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH0pLmNhdGNoKGVycm9yID0+IHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9KTtcblxuICB9XG59XG4iXX0=