import * as tslib_1 from "tslib";
import { NSystemService } from './n-system.service';
import { Injectable } from '@angular/core';
import { NgForage, NgForageCache, NgForageConfig, Driver } from 'ngforage';
import { NUtility } from './n-util.service';
var NLocalStorageService = /** @class */ (function () {
    function NLocalStorageService(ngfConfig, ngf, ngfCache) {
        this.ngfConfig = ngfConfig;
        this.ngf = ngf;
        this.ngfCache = ngfCache;
        this.storageCache = {};
    }
    NLocalStorageService.prototype.initStorage = function () {
        var _this = this;
        return new Promise(function (resolve, reject) {
            if (window['cordova']) {
                _this.initNgForage();
            }
            _this.ngf.iterate(function (value, key, iteratonNumber) {
                _this.storageCache[key] = value;
            }).then(function (result) {
                _this.checkDeviceId();
                return resolve('iteration is completed');
            }).catch(function (error) {
                return reject(error);
            });
        });
    };
    NLocalStorageService.prototype.getStorage = function () {
        return this.storageCache;
    };
    NLocalStorageService.prototype.setValue = function (key, value) {
        if (window['cordova']) {
            this.initNgForage();
        }
        this.storageCache[key] = value;
        return this.ngf.setItem(key, value).then(function (result) {
            return result;
        }, function (error) {
            console.log(error);
        });
    };
    NLocalStorageService.prototype.getValue = function (key) {
        if (!this.storageCache[key]) {
            return null;
        }
        try {
            var obj = this.storageCache[key];
            return JSON.parse(obj);
        }
        catch (error) {
            return this.storageCache[key];
        }
    };
    NLocalStorageService.prototype.remove = function (key) {
        var _this = this;
        delete this.storageCache[key];
        if (window['cordova']) {
            this.initNgForage();
        }
        this.ngf.removeItem(key).then(function (fulfilled) {
            delete _this.ngf[key];
        }).catch(function (error) {
            console.error('Could not remove', key);
        });
    };
    NLocalStorageService.prototype.clear = function () {
        this.storageCache = {};
        this.ngf.clear();
    };
    NLocalStorageService.prototype.pluginCheck = function () {
        if (window['cordova'] && window['NativeStorage']) {
            this.nativeStorageI = window['NativeStorage'];
            // return true;
        }
        // this.initStorage();
    };
    NLocalStorageService.prototype.getItemNs = function (key) {
        var _this = this;
        return new Promise(function (resolve, reject) {
            if (window['cordova'] && window['NativeStorage']) {
                _this.nativeStorageI.getItem(key, function (result) {
                    resolve(result);
                }, function (error) {
                    reject(error);
                });
            }
        });
    };
    NLocalStorageService.prototype.setItemNs = function (key, value) {
        var _this = this;
        return new Promise(function (resolve, reject) {
            if (window['cordova'] && window['NativeStorage']) {
                _this.nativeStorageI.setItem(key, value, function (result) {
                    resolve(result);
                }, function (error) {
                    reject(error);
                });
            }
        });
    };
    NLocalStorageService.prototype.removeItemNs = function (key) {
        var _this = this;
        return new Promise(function (resolve, reject) {
            if (window['cordova'] && window['NativeStorage']) {
                _this.nativeStorageI.remove(key, function (result) {
                    resolve(result);
                }, function (error) {
                    reject(error);
                });
            }
        });
    };
    NLocalStorageService.prototype.clearNs = function () {
        var _this = this;
        return new Promise(function (resolve, reject) {
            if (window['cordova'] && window['NativeStorage']) {
                _this.nativeStorageI.clear(function (result) {
                    resolve(result);
                }, function (error) {
                    reject(error);
                });
            }
        });
    };
    NLocalStorageService.prototype.initNgForage = function () {
        this.ngfConfig.configure({
            name: 'MyApp',
            driver: [
                Driver.WEB_SQL,
            ]
        });
    };
    NLocalStorageService.prototype.promiseReflect = function (promise) {
        return promise.then(function (resolved) { return { v: resolved, status: 'resolved' }; }, function (error) { return { e: error, status: 'rejected' }; });
    };
    NLocalStorageService.prototype.clearLocalStorage = function () {
        this.remove('userObj');
        this.remove('accessToken');
        this.remove('refreshToken');
        this.remove('registrationId');
    };
    /**
     * Due to timing issues and circular dependency checkDeviceId is moved from NSystemService
    */
    NLocalStorageService.prototype.checkDeviceId = function () {
        var _this = this;
        if (NSystemService.getInstance().checkDevice() === 'browser') {
            this._deviceUUID = this.getValue('uuid');
            if (!this._deviceUUID) {
                this._deviceUUID = new NUtility().generateUUID();
                this.setValue('uuid', this._deviceUUID);
            }
        }
        else {
            window['plugins'].uniqueDeviceID.get(function (uuid) {
                _this._deviceUUID = uuid;
                _this.setValue('uuid', _this._deviceUUID);
            });
        }
        return this._deviceUUID;
    };
    Object.defineProperty(NLocalStorageService.prototype, "deviceUUID", {
        get: function () {
            return this._deviceUUID;
        },
        enumerable: true,
        configurable: true
    });
    NLocalStorageService = tslib_1.__decorate([
        Injectable(),
        tslib_1.__metadata("design:paramtypes", [NgForageConfig, NgForage, NgForageCache])
    ], NLocalStorageService);
    return NLocalStorageService;
}());
export { NLocalStorageService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibi1sb2NhbFN0b3JhZ2Uuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL25ldXRyaW5vcy1zZWVkLXNlcnZpY2VzLyIsInNvdXJjZXMiOlsic3JjL2FwcC9uZXV0cmlub3Mtc2VlZC1zZXJ2aWNlcy9uLWxvY2FsU3RvcmFnZS5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDcEQsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUUzQyxPQUFPLEVBQUMsUUFBUSxFQUFFLGFBQWEsRUFBRSxjQUFjLEVBQUUsTUFBTSxFQUFDLE1BQU0sVUFBVSxDQUFDO0FBQ3pFLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUc1QztJQUtFLDhCQUFvQixTQUEwQixFQUFtQixHQUFjLEVBQW1CLFFBQXdCO1FBQXRHLGNBQVMsR0FBVCxTQUFTLENBQWlCO1FBQW1CLFFBQUcsR0FBSCxHQUFHLENBQVc7UUFBbUIsYUFBUSxHQUFSLFFBQVEsQ0FBZ0I7UUFIMUgsaUJBQVksR0FBUSxFQUFFLENBQUM7SUFJdkIsQ0FBQztJQUlELDBDQUFXLEdBQVg7UUFBQSxpQkFjQztRQWJDLE9BQU8sSUFBSSxPQUFPLENBQUMsVUFBQyxPQUFPLEVBQUUsTUFBTTtZQUNqQyxJQUFJLE1BQU0sQ0FBQyxTQUFTLENBQUMsRUFBRTtnQkFDckIsS0FBSSxDQUFDLFlBQVksRUFBRSxDQUFDO2FBQ3JCO1lBQ0QsS0FBSSxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsVUFBQyxLQUFLLEVBQUUsR0FBRyxFQUFFLGNBQWM7Z0JBQzFDLEtBQUksQ0FBQyxZQUFZLENBQUMsR0FBRyxDQUFDLEdBQUcsS0FBSyxDQUFDO1lBQ2pDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxVQUFBLE1BQU07Z0JBQ1osS0FBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO2dCQUNyQixPQUFPLE9B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SyxTQUFTLEVBQUU7WUFDNUQsSUFBSSxDQUFDLFdBQVcsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1lBRXpDLElBQUksQ0FBQyxJQUFJLENBQUMsV0FBVyxFQUFFO2dCQUNyQixJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksUUFBUSxFQUFFLENBQUMsWUFBWSxFQUFFLENBQUM7Z0JBQ2pELElBQUksQ0FBQyxRQUFRLENBQUMsTUFBTSxFQUFFLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQzthQUN6QztTQUNGO2FBQU07WUFDTCxNQUFNLENBQUMsU0FBUyxDQUFDLENBQUMsY0FBYyxDQUFDLEdBQUcsQ0FBQyxVQUFDLElBQUk7Z0JBQ3hDLEtBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSxDQUFDO2dCQUN4QixLQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sRUFBRSxLQUFJLENBQUMsV0FBVyxDQUFDLENBQUM7WUFDMUMsQ0FBQyxDQUFDLENBQUM7U0FDSjtRQUNELE9BQU8sSUFBSSxDQUFDLFdBQVcsQ0FBQztJQUMxQixDQUFDO0lBRUQsc0JBQVcsNENBQVU7YUFBckI7WUFDRSxPQUFPLElBQUksQ0FBQyxXQUFXLENBQUM7UUFDMUIsQ0FBQzs7O09BQUE7SUEzS1Usb0JBQW9CO1FBRGhDLFVBQVUsRUFBRTtpREFNcUIsY0FBYyxFQUF5QixRQUFRLEVBQThCLGFBQWE7T0FML0csb0JBQW9CLENBNEtoQztJQUFELDJCQUFDO0NBQUEsQUE1S0QsSUE0S0M7U0E1S1ksb0JBQW9CIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgTlN5c3RlbVNlcnZpY2UgfSBmcm9tICcuL24tc3lzdGVtLnNlcnZpY2UnO1xuaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0ICogYXMgbG9jYWxmb3JhZ2UgZnJvbSAnbG9jYWxmb3JhZ2UnO1xuaW1wb3J0IHtOZ0ZvcmFnZSwgTmdGb3JhZ2VDYWNoZSwgTmdGb3JhZ2VDb25maWcsIERyaXZlcn0gZnJvbSAnbmdmb3JhZ2UnO1xuaW1wb3J0IHsgTlV0aWxpdHkgfSBmcm9tICcuL24tdXRpbC5zZXJ2aWNlJztcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIE5Mb2NhbFN0b3JhZ2VTZXJ2aWNlIHtcblxuICBzdG9yYWdlQ2FjaGU6IGFueSA9IHt9O1xuICBwcml2YXRlIF9kZXZpY2VVVUlEO1xuICBwcml2YXRlIG5hdGl2ZVN0b3JhZ2VJO1xuICBjb25zdHJ1Y3Rvcihwcml2YXRlIG5nZkNvbmZpZz86IE5nRm9yYWdlQ29uZmlnLCBwcml2YXRlIHJlYWRvbmx5IG5nZj86IE5nRm9yYWdlLCBwcml2YXRlIHJlYWRvbmx5IG5nZkNhY2hlPzogTmdGb3JhZ2VDYWNoZSkge1xuICB9XG5cblxuXG4gIGluaXRTdG9yYWdlKCkge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICBpZiAod2luZG93Wydjb3Jkb3ZhJ10pIHtcbiAgICAgICAgdGhpcy5pbml0TmdGb3JhZ2UoKTtcbiAgICAgIH1cbiAgICAgIHRoaXMubmdmLml0ZXJhdGUoKHZhbHVlLCBrZXksIGl0ZXJhdG9uTnVtYmVyKSA9PiB7XG4gICAgICAgIHRoaXMuc3RvcmFnZUNhY2hlW2tleV0gPSB2YWx1ZTtcbiAgICAgIH0pLnRoZW4ocmVzdWx0ID0+IHtcbiAgICAgICAgdGhpcy5jaGVja0RldmljZUlkKCk7XG4gICAgICAgIHJldHVybiByZXNvbHZlKCdpdGVyYXRpb24gaXMgY29tcGxldGVkJylcbiAgICAgIH0pLmNhdGNoKGVycm9yID0+IHtcbiAgICAgICAgcmV0dXJuIHJlamVjdChlcnJvcik7XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfVxuXG4gIGdldFN0b3JhZ2UoKSB7XG4gICAgcmV0dXJuIHRoaXMuc3RvcmFnZUNhY2hlO1xuICB9XG5cblxuICBzZXRWYWx1ZShrZXksIHZhbHVlKSB7XG4gICAgaWYgKHdpbmRvd1snY29yZG92YSddKSB7XG4gICAgICB0aGlzLmluaXROZ0ZvcmFnZSgpO1xuICAgIH1cbiAgICB0aGlzLnN0b3JhZ2VDYWNoZVtrZXldID0gdmFsdWU7XG4gICAgcmV0dXJuIHRoaXMubmdmLnNldEl0ZW0oa2V5LCB2YWx1ZSkudGhlbihyZXN1bHQgPT4ge1xuICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9LCBlcnJvciA9PiB7XG4gICAgICBjb25zb2xlLmxvZyhlcnJvcik7XG4gICAgfSk7XG4gIH1cblxuICBnZXRWYWx1ZShrZXkpOiBhbnkgfCBQcm9taXNlPGFueT4ge1xuICAgIGlmICghdGhpcy5zdG9yYWdlQ2FjaGVba2V5XSkge1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfSB0cnkge1xuICAgICAgY29uc3Qgb2JqID0gdGhpcy5zdG9yYWdlQ2FjaGVba2V5XVxuICAgICAgcmV0dXJuIEpTT04ucGFyc2Uob2JqKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgcmV0dXJuIHRoaXMuc3RvcmFnZUNhY2hlW2tleV07XG4gICAgfVxuICB9XG5cbiAgcmVtb3ZlKGtleSkge1xuICAgIGRlbGV0ZSB0aGlzLnN0b3JhZ2VDYWNoZVtrZXldO1xuICAgIGlmICh3aW5kb3dbJ2NvcmRvdmEnXSkge1xuICAgICAgdGhpcy5pbml0TmdGb3JhZ2UoKTtcbiAgICB9XG4gICAgdGhpcy5uZ2YucmVtb3ZlSXRlbShrZXkpLnRoZW4oZnVsZmlsbGVkID0+IHtcbiAgICAgIGRlbGV0ZSB0aGlzLm5nZltrZXldO1xuICAgIH0pLmNhdGNoKGVycm9yID0+IHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ0NvdWxkIG5vdCByZW1vdmUnLCBrZXkpO1xuICAgIH0pO1xuICB9XG5cbiAgY2xlYXIoKSB7XG4gICAgdGhpcy5zdG9yYWdlQ2FjaGUgPSB7fTtcbiAgICB0aGlzLm5nZi5jbGVhcigpO1xuICB9XG5cbiAgcHJpdmF0ZSBwbHVnaW5DaGVjaygpIHtcbiAgICBpZiAod2luZG93Wydjb3Jkb3ZhJ10gJiYgd2luZG93WydOYXRpdmVTdG9yYWdlJ10pIHtcbiAgICAgIHRoaXMubmF0aXZlU3RvcmFnZUkgPSB3aW5kb3dbJ05hdGl2ZVN0b3JhZ2UnXTtcbiAgICAgIC8vIHJldHVybiB0cnVlO1xuICAgIH1cbiAgICAvLyB0aGlzLmluaXRTdG9yYWdlKCk7XG4gIH1cblxuICBwcml2YXRlIGdldEl0ZW1OcyhrZXkpIHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgaWYgKHdpbmRvd1snY29yZG92YSddICYmIHdpbmRvd1snTmF0aXZlU3RvcmFnZSddKSB7XG4gICAgICAgIHRoaXMubmF0aXZlU3RvcmFnZUkuZ2V0SXRlbShrZXksIHJlc3VsdCA9PiB7XG4gICAgICAgICAgcmVzb2x2ZShyZXN1bHQpO1xuICAgICAgICB9LCBlcnJvciA9PiB7XG4gICAgICAgICAgcmVqZWN0KGVycm9yKTtcbiAgICAgICAgfSlcbiAgICAgIH1cbiAgICB9KVxuICB9XG5cbiAgcHJpdmF0ZSBzZXRJdGVtTnMoa2V5LCB2YWx1ZSkge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICBpZiAod2luZG93Wydjb3Jkb3ZhJ10gJiYgd2luZG93WydOYXRpdmVTdG9yYWdlJ10pIHtcbiAgICAgICAgdGhpcy5uYXRpdmVTdG9yYWdlSS5zZXRJdGVtKGtleSwgdmFsdWUsIHJlc3VsdCA9PiB7XG4gICAgICAgICAgcmVzb2x2ZShyZXN1bHQpO1xuICAgICAgICB9LCBlcnJvciA9PiB7XG4gICAgICAgICAgcmVqZWN0KGVycm9yKTtcbiAgICAgICAgfSlcbiAgICAgIH1cbiAgICB9KVxuICB9XG5cbiAgcHJpdmF0ZSByZW1vdmVJdGVtTnMoa2V5KSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIGlmICh3aW5kb3dbJ2NvcmRvdmEnXSAmJiB3aW5kb3dbJ05hdGl2ZVN0b3JhZ2UnXSkge1xuICAgICAgICB0aGlzLm5hdGl2ZVN0b3JhZ2VJLnJlbW92ZShrZXksIChyZXN1bHQpID0+IHtcbiAgICAgICAgICByZXNvbHZlKHJlc3VsdCk7XG4gICAgICAgIH0sIChlcnJvcikgPT4ge1xuICAgICAgICAgIHJlamVjdChlcnJvcik7XG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgIH0pXG4gIH1cblxuICBwcml2YXRlIGNsZWFyTnMoKSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIGlmICh3aW5kb3dbJ2NvcmRvdmEnXSAmJiB3aW5kb3dbJ05hdGl2ZVN0b3JhZ2UnXSkge1xuICAgICAgICB0aGlzLm5hdGl2ZVN0b3JhZ2VJLmNsZWFyKHJlc3VsdCA9PiB7XG4gICAgICAgICAgcmVzb2x2ZShyZXN1bHQpO1xuICAgICAgICB9LCBlcnJvciA9PiB7XG4gICAgICAgICAgcmVqZWN0KGVycm9yKTtcbiAgICAgICAgfSlcbiAgICAgIH1cbiAgICB9KVxuICB9XG5cbiAgcHJpdmF0ZSBpbml0TmdGb3JhZ2UoKSB7XG4gICAgdGhpcy5uZ2ZDb25maWcuY29uZmlndXJlKHtcbiAgICAgIG5hbWU6ICdNeUFwcCcsXG4gICAgICBkcml2ZXI6IFtcbiAgICAgICAgRHJpdmVyLldFQl9TUUwsXG4gICAgICBdXG4gICAgfSk7XG5cbiAgfVxuXG4gIHByaXZhdGUgcHJvbWlzZVJlZmxlY3QocHJvbWlzZSkge1xuICAgIHJldHVybiBwcm9taXNlLnRoZW4ocmVzb2x2ZWQgPT4geyByZXR1cm4geyB2OiByZXNvbHZlZCwgc3RhdHVzOiAncmVzb2x2ZWQnIH0gfSwgZXJyb3IgPT4geyByZXR1cm4geyBlOiBlcnJvciwgc3RhdHVzOiAncmVqZWN0ZWQnIH0gfSlcbiAgfVxuXG4gIGNsZWFyTG9jYWxTdG9yYWdlKCkge1xuICAgIHRoaXMucmVtb3ZlKCd1c2VyT2JqJyk7XG4gICAgdGhpcy5yZW1vdmUoJ2FjY2Vzc1Rva2VuJyk7XG4gICAgdGhpcy5yZW1vdmUoJ3JlZnJlc2hUb2tlbicpO1xuICAgIHRoaXMucmVtb3ZlKCdyZWdpc3RyYXRpb25JZCcpO1xuICB9XG5cbiAgLyoqXG4gICAqIER1ZSB0byB0aW1pbmcgaXNzdWVzIGFuZCBjaXJjdWxhciBkZXBlbmRlbmN5IGNoZWNrRGV2aWNlSWQgaXMgbW92ZWQgZnJvbSBOU3lzdGVtU2VydmljZVxuICAqL1xuXG4gIGNoZWNrRGV2aWNlSWQoKSB7XG4gICAgaWYgKE5TeXN0ZW1TZXJ2aWNlLmdldEluc3RhbmNlKCkuY2hlY2tEZXZpY2UoKSA9PT0gJ2Jyb3dzZXInKSB7XG4gICAgICB0aGlzLl9kZXZpY2VVVUlEID0gdGhpcy5nZXRWYWx1ZSgndXVpZCcpO1xuXG4gICAgICBpZiAoIXRoaXMuX2RldmljZVVVSUQpIHtcbiAgICAgICAgdGhpcy5fZGV2aWNlVVVJRCA9IG5ldyBOVXRpbGl0eSgpLmdlbmVyYXRlVVVJRCgpO1xuICAgICAgICB0aGlzLnNldFZhbHVlKCd1dWlkJywgdGhpcy5fZGV2aWNlVVVJRCk7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIHdpbmRvd1sncGx1Z2lucyddLnVuaXF1ZURldmljZUlELmdldCgodXVpZCkgPT4ge1xuICAgICAgICB0aGlzLl9kZXZpY2VVVUlEID0gdXVpZDtcbiAgICAgICAgdGhpcy5zZXRWYWx1ZSgndXVpZCcsIHRoaXMuX2RldmljZVVVSUQpO1xuICAgICAgfSk7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLl9kZXZpY2VVVUlEO1xuICB9XG5cbiAgcHVibGljIGdldCBkZXZpY2VVVUlEKCkge1xuICAgIHJldHVybiB0aGlzLl9kZXZpY2VVVUlEO1xuICB9XG59XG4iXX0=