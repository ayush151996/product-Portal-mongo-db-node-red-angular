import * as tslib_1 from "tslib";
import { Injectable, Injector } from '@angular/core';
import { HttpHeaders, HttpErrorResponse, HttpClient } from '@angular/common/http';
import { BehaviorSubject, throwError } from 'rxjs';
import { NHTTPLoaderService } from './n-HTTPLoader.service';
import { NSystemService } from './n-system.service';
import { NSessionStorageService } from './n-sessionStorage.service';
import { NLocalStorageService } from './n-localStorage.service';
import { NTokenService } from './n-token.service';
import { NPubSubService } from './n-pubSub.service';
import { timeout, catchError, finalize, switchMap, filter, take } from 'rxjs/operators';
var NHttpService = /** @class */ (function () {
    function NHttpService(nHTTPLoader, inj, nLocalStorageService, nTokenService) {
        this.nHTTPLoader = nHTTPLoader;
        this.inj = inj;
        this.nLocalStorageService = nLocalStorageService;
        this.nTokenService = nTokenService;
        this.timeout = 90000;
        this.isRefreshingToken = false;
        this.tokenSubject = new BehaviorSubject(null);
        this.systemService = NSystemService.getInstance();
        this.nSessionStorage = new NSessionStorageService();
        this.appProperties = this.systemService.getVal('properties');
        this.nPubSubService = new NPubSubService();
    }
    NHttpService.prototype.intercept = function (req, next) {
        var _this = this;
        this.requestInterceptor();
        // Pass on the cloned request instead of the original request.
        return next.handle(this.requestOptions(req))
            .pipe(timeout(this.timeout), catchError(function (error) { return _this.onCatch(error, req, next); }), finalize(function () {
            _this.onFinally();
        }));
    };
    NHttpService.prototype.updateToken = function (error, req, next) {
        var _this = this;
        if (this.appProperties.appAuthenticationStrategy === 'activeDirectory' ||
            this.appProperties.appAuthenticationStrategy === 'localAuth') {
            if (!this.isRefreshingToken) {
                this.isRefreshingToken = true;
                // Reset here so that the following requests wait until the token
                // comes back from the refreshToken call.
                this.tokenSubject.next(null);
                return this.refreshToken()
                    .pipe(switchMap(function (tokensObj) {
                    if (tokensObj) {
                        _this.nTokenService.updateTokens(tokensObj);
                        var newToken = tokensObj['accessToken'];
                        _this.tokenSubject.next(newToken);
                        return next.handle(_this.requestOptions(req));
                    }
                    return throwError(new Error('Can\'t refresh the token'));
                }), catchError(function (err) { return _this.onCatchError(err); }), finalize(function () { return _this.isRefreshingToken = false; }));
            }
            else {
                return this.tokenSubject.pipe(filter(function (token) { return token != null; }), take(1), switchMap(function (token) { return next.handle(_this.requestOptions(req)); }));
            }
        }
        else {
            return this.onCatchError(error);
        }
    };
    NHttpService.prototype.refreshToken = function () {
        var http = this.inj.get(HttpClient);
        var appProperties = this.systemService.getVal('properties');
        var refreshUrl = this.systemService.getAuthUrl() + appProperties.appName + '/refresh';
        var body = {
            'platformDetails': this.systemService.getPlatformDetails(this.systemService.checkDevice()),
            'userKey': this.nSessionStorage.getValue('userObj')['userKey'],
            'refreshToken': this.nSessionStorage.getValue('refreshToken')
        };
        body.platformDetails['uuid'] = this.nLocalStorageService.getValue('uuid');
        return http.post(refreshUrl, body);
    };
    /**
     * Request options.
     * @param options
     * @returns HttpRequest
     */
    NHttpService.prototype.requestOptions = function (req) {
        var headers = req.headers;
        if (req.headers == null) {
            headers = new HttpHeaders();
        }
        req = req.clone({
            url: this.getFullUrl(req.url),
            headers: headers
        });
        var baseUrl = NSystemService.getInstance().getVal('baseUrl');
        var isArt = (baseUrl !== '' && req.url.includes(baseUrl));
        return isArt ? this.addDefaultHeaders(req) : req;
    };
    /**
    * Default options.
    * @param options
    * @returns HttpHeadedrs
    */
    NHttpService.prototype.addDefaultHeaders = function (req) {
        /**
         * TODO: Add all default Headers over here
         */
        if (!req.headers.has('Access-Control-Allow-Origin')) {
            req.headers = req.headers.set('Access-Control-Allow-Origin', '*');
        }
        if (!req.headers.has('Content-Type')) {
            req.headers = req.headers.set('Content-Type', 'application/json');
        }
        else if (req.headers.has('Content-Type') && (req.headers.get('Content-Type') === 'no-content')) {
            req.headers = req.headers.delete('Content-Type');
        }
        if (!req.headers.has('Accept')) {
            req.headers = req.headers.set('Accept', 'application/json');
        }
        if (!req.headers.has('Authorization')) {
            this.appProperties = this.systemService.getVal('properties');
            if (this.appProperties && this.appProperties.appAuthenticationStrategy === 'basicAuth') {
                var username = void 0, password = void 0;
                if (this.appProperties.basicAuthUser && this.appProperties.basicAuthPassword) {
                    username = this.appProperties.basicAuthUser;
                    password = this.appProperties.basicAuthPassword;
                }
                else {
                    username = "bhive-art-proxyuser";
                    password = "password";
                    console.warn("Authentication strategy: Basic Auth. basicAuthUser and basicAuthPassword are not configured in environment. Setting default values.");
                }
                req.headers = req.headers.set('Authorization', 'Basic ' + btoa(username + ":" + password));
            }
            else if (this.appProperties && (this.appProperties.appAuthenticationStrategy === 'activeDirectory' ||
                this.appProperties.appAuthenticationStrategy === 'localAuth')) {
                if (this.nSessionStorage.getValue('accessToken')) {
                    req.headers = req.headers.set('Authorization', 'Bearer ' + this.nSessionStorage.getValue('accessToken'));
                }
            }
        }
        return req;
    };
    /**
     * Build API url.
     * @param url
     * @returns string
     */
    NHttpService.prototype.getFullUrl = function (url) {
        // return full URL to API here
        return url;
    };
    /**
     * Request interceptor.
     */
    NHttpService.prototype.requestInterceptor = function () {
        this.nHTTPLoader.isHTTPRequestInProgress(true);
    };
    /**
     * Response interceptor.
     */
    NHttpService.prototype.responseInterceptor = function () {
        this.nHTTPLoader.isHTTPRequestInProgress(false);
    };
    /**
      * Error handler.
      * @param error
      * @param caught
      * @returns ErrorObservable
      */
    NHttpService.prototype.onCatch = function (error, req, next) {
        if (error instanceof HttpErrorResponse) {
            if (error.status === 403 && error.error.message === 'jwt expired') {
                return this.updateToken(error, req, next);
            }
            else {
                return this.onSubscribeError(error);
            }
        }
        else {
            return this.onSubscribeError(error);
        }
    };
    /**
     * onSubscribeError
     * @param error
     */
    NHttpService.prototype.onSubscribeError = function (err) {
        this.nHTTPLoader.alertError(err);
        return this.onCatchError(err);
    };
    /**
     * onFinally
     */
    NHttpService.prototype.onFinally = function () {
        this.responseInterceptor();
    };
    NHttpService.prototype.onCatchError = function (error) {
        return throwError(error);
    };
    NHttpService = tslib_1.__decorate([
        Injectable(),
        tslib_1.__metadata("design:paramtypes", [NHTTPLoaderService, Injector,
            NLocalStorageService, NTokenService])
    ], NHttpService);
    return NHttpService;
}());
export { NHttpService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibi1IVFRQLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9uZXV0cmlub3Mtc2VlZC1zZXJ2aWNlcy8iLCJzb3VyY2VzIjpbInNyYy9hcHAvbmV1dHJpbm9zLXNlZWQtc2VydmljZXMvbi1IVFRQLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3JELE9BQU8sRUFLTCxXQUFXLEVBRVgsaUJBQWlCLEVBQ2pCLFVBQVUsRUFDWCxNQUFNLHNCQUFzQixDQUFDO0FBQzlCLE9BQU8sRUFBYyxlQUFlLEVBQUUsVUFBVSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQy9ELE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBQzVELE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUNwRCxPQUFPLEVBQUUsc0JBQXNCLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUNwRSxPQUFPLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUNoRSxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDbEQsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBQ3BELE9BQU8sRUFBRSxPQUFPLEVBQUUsVUFBVSxFQUFFLFFBQVEsRUFBRSxTQUFTLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBR3hGO0lBU0Usc0JBQW9CLFdBQStCLEVBQVUsR0FBYSxFQUNoRSxvQkFBMEMsRUFBVSxhQUE0QjtRQUR0RSxnQkFBVyxHQUFYLFdBQVcsQ0FBb0I7UUFBVSxRQUFHLEdBQUgsR0FBRyxDQUFVO1FBQ2hFLHlCQUFvQixHQUFwQixvQkFBb0IsQ0FBc0I7UUFBVSxrQkFBYSxHQUFiLGFBQWEsQ0FBZTtRQVQxRixZQUFPLEdBQUcsS0FBSyxDQUFDO1FBSWhCLHNC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QU07WUFDTCxPQUFPLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxLQUFLLENBQUMsQ0FBQztTQUNyQztJQUNILENBQUM7SUFFRDs7O09BR0c7SUFDSyx1Q0FBZ0IsR0FBeEIsVUFBeUIsR0FBc0I7UUFDN0MsSUFBSSxDQUFDLFdBQVcsQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDakMsT0FBTyxJQUFJLENBQUMsWUFBWSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQ2hDLENBQUM7SUFDRDs7T0FFRztJQUNLLGdDQUFTLEdBQWpCO1FBQ0UsSUFBSSxDQUFDLG1CQUFtQixFQUFFLENBQUM7SUFDN0IsQ0FBQztJQUVPLG1DQUFZLEdBQXBCLFVBQXFCLEtBQXdCO1FBQzNDLE9BQU8sVUFBVSxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQzNCLENBQUM7SUE1TVUsWUFBWTtRQUR4QixVQUFVLEVBQUU7aURBVXNCLGtCQUFrQixFQUFlLFFBQVE7WUFDMUMsb0JBQW9CLEVBQXlCLGFBQWE7T0FWL0UsWUFBWSxDQThNeEI7SUFBRCxtQkFBQztDQUFBLEFBOU1ELElBOE1DO1NBOU1ZLFlBQVkiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBJbmplY3RvciB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHtcbiAgSHR0cEV2ZW50LFxuICBIdHRwSW50ZXJjZXB0b3IsXG4gIEh0dHBIYW5kbGVyLFxuICBIdHRwUmVxdWVzdCxcbiAgSHR0cEhlYWRlcnMsXG4gIEh0dHBSZXNwb25zZSxcbiAgSHR0cEVycm9yUmVzcG9uc2UsXG4gIEh0dHBDbGllbnRcbn0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uL2h0dHAnO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgQmVoYXZpb3JTdWJqZWN0LCB0aHJvd0Vycm9yIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBOSFRUUExvYWRlclNlcnZpY2UgfSBmcm9tICcuL24tSFRUUExvYWRlci5zZXJ2aWNlJztcbmltcG9ydCB7IE5TeXN0ZW1TZXJ2aWNlIH0gZnJvbSAnLi9uLXN5c3RlbS5zZXJ2aWNlJztcbmltcG9ydCB7IE5TZXNzaW9uU3RvcmFnZVNlcnZpY2UgfSBmcm9tICcuL24tc2Vzc2lvblN0b3JhZ2Uuc2VydmljZSc7XG5pbXBvcnQgeyBOTG9jYWxTdG9yYWdlU2VydmljZSB9IGZyb20gJy4vbi1sb2NhbFN0b3JhZ2Uuc2VydmljZSc7XG5pbXBvcnQgeyBOVG9rZW5TZXJ2aWNlIH0gZnJvbSAnLi9uLXRva2VuLnNlcnZpY2UnO1xuaW1wb3J0IHsgTlB1YlN1YlNlcnZpY2UgfSBmcm9tICcuL24tcHViU3ViLnNlcnZpY2UnO1xuaW1wb3J0IHsgdGltZW91dCwgY2F0Y2hFcnJvciwgZmluYWxpemUsIHN3aXRjaE1hcCwgZmlsdGVyLCB0YWtlIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgTkh0dHBTZXJ2aWNlIHtcbiAgdGltZW91dCA9IDkwMDAwO1xuICBzeXN0ZW1TZXJ2aWNlO1xuICBuU2Vzc2lvblN0b3JhZ2U7XG4gIGFwcFByb3BlcnRpZXM7XG4gIGlzUmVmcmVzaGluZ1Rva2VuID0gZmFsc2U7XG4gIG5QdWJTdWJTZXJ2aWNlO1xuICB0b2tlblN1YmplY3Q6IEJlaGF2aW9yU3ViamVjdDxzdHJpbmc+ID0gbmV3IEJlaGF2aW9yU3ViamVjdDxzdHJpbmc+KG51bGwpO1xuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgbkhUVFBMb2FkZXI6IE5IVFRQTG9hZGVyU2VydmljZSwgcHJpdmF0ZSBpbmo6IEluamVjdG9yLFxuICAgIHByaXZhdGUgbkxvY2FsU3RvcmFnZVNlcnZpY2U6IE5Mb2NhbFN0b3JhZ2VTZXJ2aWNlLCBwcml2YXRlIG5Ub2tlblNlcnZpY2U6IE5Ub2tlblNlcnZpY2UpIHtcbiAgICB0aGlzLnN5c3RlbVNlcnZpY2UgPSBOU3lzdGVtU2VydmljZS5nZXRJbnN0YW5jZSgpO1xuICAgIHRoaXMublNlc3Npb25TdG9yYWdlID0gbmV3IE5TZXNzaW9uU3RvcmFnZVNlcnZpY2UoKTtcbiAgICB0aGlzLmFwcFByb3BlcnRpZXMgPSB0aGlzLnN5c3RlbVNlcnZpY2UuZ2V0VmFsKCdwcm9wZXJ0aWVzJyk7XG4gICAgdGhpcy5uUHViU3ViU2VydmljZSA9IG5ldyBOUHViU3ViU2VydmljZSgpO1xuICB9XG5cbiAgaW50ZXJjZXB0KHJlcTogSHR0cFJlcXVlc3Q8YW55PiwgbmV4dDogSHR0cEhhbmRsZXIpOiBPYnNlcnZhYmxlPEh0dHBFdmVudDxhbnk+PiB7XG4gICAgdGhpcy5yZXF1ZXN0SW50ZXJjZXB0b3IoKTtcblxuICAgIC8vIFBhc3Mgb24gdGhlIGNsb25lZCByZXF1ZXN0IGluc3RlYWQgb2YgdGhlIG9yaWdpbmFsIHJlcXVlc3QuXG4gICAgcmV0dXJuIG5leHQuaGFuZGxlKHRoaXMucmVxdWVzdE9wdGlvbnMocmVxKSlcbiAgICAgIC5waXBlKHRpbWVvdXQodGhpcy50aW1lb3V0KVxuICAgICAgICAsIGNhdGNoRXJyb3IoZXJyb3IgPT4gdGhpcy5vbkNhdGNoKGVycm9yLCByZXEsIG5leHQpKVxuICAgICAgICAsIGZpbmFsaXplKCgpID0+IHtcbiAgICAgICAgICB0aGlzLm9uRmluYWxseSgpO1xuICAgICAgICB9KSk7XG4gIH1cblxuICB1cGRhdGVUb2tlbihlcnJvcjogSHR0cEVycm9yUmVzcG9uc2UsIHJlcTogSHR0cFJlcXVlc3Q8YW55PiwgbmV4dDogSHR0cEhhbmRsZXIpOiBhbnkge1xuICAgIGlmICh0aGlzLmFwcFByb3BlcnRpZXMuYXBwQXV0aGVudGljYXRpb25TdHJhdGVneSA9PT0gJ2FjdGl2ZURpcmVjdG9yeScgfHxcbiAgICAgIHRoaXMuYXBwUHJvcGVydGllcy5hcHBBdXRoZW50aWNhdGlvblN0cmF0ZWd5ID09PSAnbG9jYWxBdXRoJykge1xuICAgICAgaWYgKCF0aGlzLmlzUmVmcmVzaGluZ1Rva2VuKSB7XG4gICAgICAgIHRoaXMuaXNSZWZyZXNoaW5nVG9rZW4gPSB0cnVlO1xuXG4gICAgICAgIC8vIFJlc2V0IGhlcmUgc28gdGhhdCB0aGUgZm9sbG93aW5nIHJlcXVlc3RzIHdhaXQgdW50aWwgdGhlIHRva2VuXG4gICAgICAgIC8vIGNvbWVzIGJhY2sgZnJvbSB0aGUgcmVmcmVzaFRva2VuIGNhbGwuXG4gICAgICAgIHRoaXMudG9rZW5TdWJqZWN0Lm5leHQobnVsbCk7XG5cbiAgICAgICAgcmV0dXJuIHRoaXMucmVmcmVzaFRva2VuKClcbiAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgIHN3aXRjaE1hcCgodG9rZW5zT2JqOiBPYmplY3QpID0+IHtcbiAgICAgICAgICAgICAgaWYgKHRva2Vuc09iaikge1xuICAgICAgICAgICAgICAgIHRoaXMublRva2VuU2VydmljZS51cGRhdGVUb2tlbnModG9rZW5zT2JqKTtcbiAgICAgICAgICAgICAgICBjb25zdCBuZXdUb2tlbiA9IHRva2Vuc09ialsnYWNjZXNzVG9rZW4nXTtcbiAgICAgICAgICAgICAgICB0aGlzLnRva2VuU3ViamVjdC5uZXh0KG5ld1Rva2VuKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gbmV4dC5oYW5kbGUodGhpcy5yZXF1ZXN0T3B0aW9ucyhyZXEpKTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICByZXR1cm4gdGhyb3dFcnJvcihuZXcgRXJyb3IoJ0NhblxcJ3QgcmVmcmVzaCB0aGUgdG9rZW4nKSk7XG4gICAgICAgICAgICB9KSxcbiAgICAgICAgICAgIGNhdGNoRXJyb3IoZXJyID0+IHRoaXMub25DYXRjaEVycm9yKGVycikpLFxuICAgICAgICAgICAgZmluYWxpemUoKCkgPT4gdGhpcy5pc1JlZnJlc2hpbmdUb2tlbiA9IGZhbHNlKVxuICAgICAgICAgICk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4gdGhpcy50b2tlblN1YmplY3QucGlwZShcbiAgICAgICAgICBmaWx0ZXIodG9rZW4gPT4gdG9rZW4gIT0gbnVsbCksXG4gICAgICAgICAgdGFrZSgxKSxcbiAgICAgICAgICBzd2l0Y2hNYXAodG9rZW4gPT4gbmV4dC5oYW5kbGUodGhpcy5yZXF1ZXN0T3B0aW9ucyhyZXEpKSlcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIHRoaXMub25DYXRjaEVycm9yKGVycm9yKTtcbiAgICB9XG4gIH1cblxuICByZWZyZXNoVG9rZW4oKSB7XG4gICAgY29uc3QgaHR0cCA9IHRoaXMuaW5qLmdldChIdHRwQ2xpZW50KTtcbiAgICBjb25zdCBhcHBQcm9wZXJ0aWVzID0gdGhpcy5zeXN0ZW1TZXJ2aWNlLmdldFZhbCgncHJvcGVydGllcycpO1xuICAgIGNvbnN0IHJlZnJlc2hVcmwgPSB0aGlzLnN5c3RlbVNlcnZpY2UuZ2V0QXV0aFVybCgpICsgYXBwUHJvcGVydGllcy5hcHBOYW1lICsgJy9yZWZyZXNoJztcbiAgICBjb25zdCBib2R5ID0ge1xuICAgICAgJ3BsYXRmb3JtRGV0YWlscyc6IHRoaXMuc3lzdGVtU2VydmljZS5nZXRQbGF0Zm9ybURldGFpbHModGhpcy5zeXN0ZW1TZXJ2aWNlLmNoZWNrRGV2aWNlKCkpLFxuICAgICAgJ3VzZXJLZXknOiB0aGlzLm5TZXNzaW9uU3RvcmFnZS5nZXRWYWx1ZSgndXNlck9iaicpWyd1c2VyS2V5J10sXG4gICAgICAncmVmcmVzaFRva2VuJzogdGhpcy5uU2Vzc2lvblN0b3JhZ2UuZ2V0VmFsdWUoJ3JlZnJlc2hUb2tlbicpXG4gICAgfTtcbiAgICBib2R5LnBsYXRmb3JtRGV0YWlsc1sndXVpZCddID0gdGhpcy5uTG9jYWxTdG9yYWdlU2VydmljZS5nZXRWYWx1ZSgndXVpZCcpO1xuICAgIHJldHVybiBodHRwLnBvc3QocmVmcmVzaFVybCwgYm9keSk7XG4gIH1cblxuXG4gIC8qKlxuICAgKiBSZXF1ZXN0IG9wdGlvbnMuXG4gICAqIEBwYXJhbSBvcHRpb25zXG4gICAqIEByZXR1cm5zIEh0dHBSZXF1ZXN0XG4gICAqL1xuICBwcml2YXRlIHJlcXVlc3RPcHRpb25zKHJlcT86IEh0dHBSZXF1ZXN0PGFueT4pIHtcbiAgICBsZXQgaGVhZGVycyA9IHJlcS5oZWFkZXJzO1xuICAgIGlmIChyZXEuaGVhZGVycyA9PSBudWxsKSB7XG4gICAgICBoZWFkZXJzID0gbmV3IEh0dHBIZWFkZXJzKCk7XG4gICAgfVxuICAgIHJlcSA9IHJlcS5jbG9uZSh7XG4gICAgICB1cmw6IHRoaXMuZ2V0RnVsbFVybChyZXEudXJsKSxcbiAgICAgIGhlYWRlcnM6IGhlYWRlcnNcbiAgICB9KTtcbiAgICBjb25zdCBiYXNlVXJsID0gTlN5c3RlbVNlcnZpY2UuZ2V0SW5zdGFuY2UoKS5nZXRWYWwoJ2Jhc2VVcmwnKTtcbiAgICBjb25zdCBpc0FydCA9IChiYXNlVXJsICE9PSAnJyAmJiByZXEudXJsLmluY2x1ZGVzKGJhc2VVcmwpKTtcbiAgICByZXR1cm4gaXNBcnQgPyB0aGlzLmFkZERlZmF1bHRIZWFkZXJzKHJlcSkgOiByZXE7XG4gIH1cblxuXG4gIC8qKlxuICAqIERlZmF1bHQgb3B0aW9ucy5cbiAgKiBAcGFyYW0gb3B0aW9uc1xuICAqIEByZXR1cm5zIEh0dHBIZWFkZWRyc1xuICAqL1xuICBwcml2YXRlIGFkZERlZmF1bHRIZWFkZXJzKHJlcTogYW55KSB7XG4gICAgLyoqXG4gICAgICogVE9ETzogQWRkIGFsbCBkZWZhdWx0IEhlYWRlcnMgb3ZlciBoZXJlXG4gICAgICovXG4gICAgaWYgKCFyZXEuaGVhZGVycy5oYXMoJ0FjY2Vzcy1Db250cm9sLUFsbG93LU9yaWdpbicpKSB7XG4gICAgICByZXEuaGVhZGVycyA9IHJlcS5oZWFkZXJzLnNldCgnQWNjZXNzLUNvbnRyb2wtQWxsb3ctT3JpZ2luJywgJyonKTtcbiAgICB9XG5cbiAgICBpZiAoIXJlcS5oZWFkZXJzLmhhcygnQ29udGVudC1UeXBlJykpIHtcbiAgICAgIHJlcS5oZWFkZXJzID0gcmVxLmhlYWRlcnMuc2V0KCdDb250ZW50LVR5cGUnLCAnYXBwbGljYXRpb24vanNvbicpO1xuICAgIH0gZWxzZSBpZiAocmVxLmhlYWRlcnMuaGFzKCdDb250ZW50LVR5cGUnKSAmJiAocmVxLmhlYWRlcnMuZ2V0KCdDb250ZW50LVR5cGUnKSA9PT0gJ25vLWNvbnRlbnQnKSkge1xuICAgICAgcmVxLmhlYWRlcnMgPSByZXEuaGVhZGVycy5kZWxldGUoJ0NvbnRlbnQtVHlwZScpO1xuICAgIH1cblxuICAgIGlmICghcmVxLmhlYWRlcnMuaGFzKCdBY2NlcHQnKSkge1xuICAgICAgcmVxLmhlYWRlcnMgPSByZXEuaGVhZGVycy5zZXQoJ0FjY2VwdCcsICdhcHBsaWNhdGlvbi9qc29uJyk7XG4gICAgfVxuXG4gICAgaWYgKCFyZXEuaGVhZGVycy5oYXMoJ0F1dGhvcml6YXRpb24nKSkge1xuICAgICAgdGhpcy5hcHBQcm9wZXJ0aWVzID0gdGhpcy5zeXN0ZW1TZXJ2aWNlLmdldFZhbCgncHJvcGVydGllcycpO1xuICAgICAgaWYgKHRoaXMuYXBwUHJvcGVydGllcyAmJiB0aGlzLmFwcFByb3BlcnRpZXMuYXBwQXV0aGVudGljYXRpb25TdHJhdGVneSA9PT0gJ2Jhc2ljQXV0aCcpIHtcbiAgICAgICAgbGV0IHVzZXJuYW1lLCBwYXNzd29yZDtcbiAgICAgICAgaWYgKHRoaXMuYXBwUHJvcGVydGllcy5iYXNpY0F1dGhVc2VyICYmIHRoaXMuYXBwUHJvcGVydGllcy5iYXNpY0F1dGhQYXNzd29yZCkge1xuICAgICAgICAgIHVzZXJuYW1lID0gdGhpcy5hcHBQcm9wZXJ0aWVzLmJhc2ljQXV0aFVzZXI7XG4gICAgICAgICAgcGFzc3dvcmQgPSB0aGlzLmFwcFByb3BlcnRpZXMuYmFzaWNBdXRoUGFzc3dvcmQ7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdXNlcm5hbWUgPSBcImJoaXZlLWFydC1wcm94eXVzZXJcIjtcbiAgICAgICAgICBwYXNzd29yZCA9IFwicGFzc3dvcmRcIjtcbiAgICAgICAgICBjb25zb2xlLndhcm4oXCJBdXRoZW50aWNhdGlvbiBzdHJhdGVneTogQmFzaWMgQXV0aC4gYmFzaWNBdXRoVXNlciBhbmQgYmFzaWNBdXRoUGFzc3dvcmQgYXJlIG5vdCBjb25maWd1cmVkIGluIGVudmlyb25tZW50LiBTZXR0aW5nIGRlZmF1bHQgdmFsdWVzLlwiKTtcbiAgICAgICAgfVxuICAgICAgICByZXEuaGVhZGVycyA9IHJlcS5oZWFkZXJzLnNldCgnQXV0aG9yaXphdGlvbicsICdCYXNpYyAnICsgYnRvYSh1c2VybmFtZSArIFwiOlwiICsgcGFzc3dvcmQpKTtcbiAgICAgIH0gZWxzZSBpZiAodGhpcy5hcHBQcm9wZXJ0aWVzICYmICh0aGlzLmFwcFByb3BlcnRpZXMuYXBwQXV0aGVudGljYXRpb25TdHJhdGVneSA9PT0gJ2FjdGl2ZURpcmVjdG9yeScgfHxcbiAgICAgICAgdGhpcy5hcHBQcm9wZXJ0aWVzLmFwcEF1dGhlbnRpY2F0aW9uU3RyYXRlZ3kgPT09ICdsb2NhbEF1dGgnKSkge1xuICAgICAgICBpZiAodGhpcy5uU2Vzc2lvblN0b3JhZ2UuZ2V0VmFsdWUoJ2FjY2Vzc1Rva2VuJykpIHtcbiAgICAgICAgICByZXEuaGVhZGVycyA9IHJlcS5oZWFkZXJzLnNldCgnQXV0aG9yaXphdGlvbicsICdCZWFyZXIgJyArIHRoaXMublNlc3Npb25TdG9yYWdlLmdldFZhbHVlKCdhY2Nlc3NUb2tlbicpKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gcmVxO1xuICB9XG5cbiAgLyoqXG4gICAqIEJ1aWxkIEFQSSB1cmwuXG4gICAqIEBwYXJhbSB1cmxcbiAgICogQHJldHVybnMgc3RyaW5nXG4gICAqL1xuICBwcml2YXRlIGdldEZ1bGxVcmwodXJsOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgIC8vIHJldHVybiBmdWxsIFVSTCB0byBBUEkgaGVyZVxuICAgIHJldHVybiB1cmw7XG4gIH1cblxuICAvKipcbiAgICogUmVxdWVzdCBpbnRlcmNlcHRvci5cbiAgICovXG4gIHByaXZhdGUgcmVxdWVzdEludGVyY2VwdG9yKCk6IHZvaWQge1xuICAgIHRoaXMubkhUVFBMb2FkZXIuaXNIVFRQUmVxdWVzdEluUHJvZ3Jlc3ModHJ1ZSk7XG4gIH1cblxuICAvKipcbiAgICogUmVzcG9uc2UgaW50ZXJjZXB0b3IuXG4gICAqL1xuICBwcml2YXRlIHJlc3BvbnNlSW50ZXJjZXB0b3IoKTogdm9pZCB7XG4gICAgdGhpcy5uSFRUUExvYWRlci5pc0hUVFBSZXF1ZXN0SW5Qcm9ncmVzcyhmYWxzZSk7XG4gIH1cblxuICAvKipcbiAgICAqIEVycm9yIGhhbmRsZXIuXG4gICAgKiBAcGFyYW0gZXJyb3JcbiAgICAqIEBwYXJhbSBjYXVnaHRcbiAgICAqIEByZXR1cm5zIEVycm9yT2JzZXJ2YWJsZVxuICAgICovXG4gIHByaXZhdGUgb25DYXRjaChlcnJvcjogSHR0cEVycm9yUmVzcG9uc2UsIHJlcTogSHR0cFJlcXVlc3Q8YW55PiwgbmV4dDogSHR0cEhhbmRsZXIpOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgIGlmIChlcnJvciBpbnN0YW5jZW9mIEh0dHBFcnJvclJlc3BvbnNlKSB7XG4gICAgICBpZiAoKDxIdHRwRXJyb3JSZXNwb25zZT5lcnJvcikuc3RhdHVzID09PSA0MDMgJiYgKDxIdHRwRXJyb3JSZXNwb25zZT5lcnJvcikuZXJyb3IubWVzc2FnZSA9PT0gJ2p3dCBleHBpcmVkJykge1xuICAgICAgICByZXR1cm4gdGhpcy51cGRhdGVUb2tlbihlcnJvciwgcmVxLCBuZXh0KTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiB0aGlzLm9uU3Vic2NyaWJlRXJyb3IoZXJyb3IpO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gdGhpcy5vblN1YnNjcmliZUVycm9yKGVycm9yKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogb25TdWJzY3JpYmVFcnJvclxuICAgKiBAcGFyYW0gZXJyb3JcbiAgICovXG4gIHByaXZhdGUgb25TdWJzY3JpYmVFcnJvcihlcnI6IEh0dHBFcnJvclJlc3BvbnNlKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICB0aGlzLm5IVFRQTG9hZGVyLmFsZXJ0RXJyb3IoZXJyKTtcbiAgICByZXR1cm4gdGhpcy5vbkNhdGNoRXJyb3IoZXJyKTtcbiAgfVxuICAvKipcbiAgICogb25GaW5hbGx5XG4gICAqL1xuICBwcml2YXRlIG9uRmluYWxseSgpOiB2b2lkIHtcbiAgICB0aGlzLnJlc3BvbnNlSW50ZXJjZXB0b3IoKTtcbiAgfVxuXG4gIHByaXZhdGUgb25DYXRjaEVycm9yKGVycm9yOiBIdHRwRXJyb3JSZXNwb25zZSk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgcmV0dXJuIHRocm93RXJyb3IoZXJyb3IpO1xuICB9XG5cbn1cbiJdfQ==