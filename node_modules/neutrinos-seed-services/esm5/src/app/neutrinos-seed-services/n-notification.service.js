import * as tslib_1 from "tslib";
import { Injectable } from '@angular/core';
import { NSystemService } from './n-system.service';
import { NLocalStorageService } from './n-localStorage.service';
import * as firebase from 'firebase';
import { NPubSubService } from './n-pubSub.service';
import { HttpClient } from '@angular/common/http';
import { NSessionStorageService } from './n-sessionStorage.service';
// import { Router } from '@angular/router';
import { NHTTPLoaderService } from './n-HTTPLoader.service';
var NNotificationService = /** @class */ (function () {
    function NNotificationService(localStorageService, pubSubService, http, bHttpLoader) {
        var _this = this;
        this.localStorageService = localStorageService;
        this.pubSubService = pubSubService;
        this.http = http;
        this.bHttpLoader = bHttpLoader;
        // private static instance: NNotificationService;
        this.systemService = NSystemService.getInstance();
        this.possiblePushTypes = ['APNS', 'FCM'];
        this.firebaseSenderId = this.systemService.getVal('firebaseSenderId');
        this.isNotificationEnabled = this.systemService.getVal('isNotificationEnabled');
        this.appName = this.systemService.getVal('appName');
        this.deviceType = this.systemService.deviceType;
        this.sessionStorage = new NSessionStorageService();
        this.loginSubscribe = this.pubSubService.$sub('firebaseRegister', function () {
            _this.enableNotification();
        });
    }
    NNotificationService.prototype.ngOnInit = function () {
    };
    NNotificationService.prototype.enableNotification = function () {
        var _this = this;
        var pushType = this.getPushType(this.systemService.getVal('pushType'));
        document.addEventListener('deviceready', function (event) {
            if (_this.isNotificationEnabled) {
                if (_this.deviceType && _this.deviceType != 'browser') {
                    _this.deviceType = _this.systemService.deviceType;
                    _this.checkPermission(pushType).then(function (res) {
                        if (res) {
                            _this.initializeNotifications(pushType);
                        }
                    });
                }
            }
        });
        if (this.isNotificationEnabled && pushType !== 'APNS') {
            if (this.deviceType && this.deviceType == 'browser' && window['Notification']) {
                this.initialiseWebPush();
            }
        }
    };
    NNotificationService.prototype.initialiseWebPush = function () {
        var __this = this;
        var messaging = firebase.messaging();
        Notification.requestPermission()
            .then(function () {
            return messaging.getToken();
        })
            .then(function (token) {
            if (token) {
                __this.sendRegDetails(token);
            }
        })
            .catch(function (err) {
            __this.bHttpLoader.alertError(err);
        });
        messaging.onMessage(function (payload) {
            if (payload['notification']) {
                var notificationObj = payload['notification'];
                var options = {
                    body: notificationObj.body,
                    icon: notificationObj.icon
                };
                // creating a native browser message
                var notificationUI = new Notification(notificationObj.title, options);
                notificationUI.onclick = function () {
                    window.focus(); // window is focused when the user clicks the notification using this
                };
            }
        });
    };
    NNotificationService.prototype.checkPermission = function (pushType) {
        var _this = this;
        // Android & iOS only
        // Checks whether the push notification permission has been granted.
        return new Promise(function (resolve) {
            pushType = _this.getPushType(pushType);
            if ((_this.deviceType === 'Android' || _this.deviceType === 'iOS') && (pushType === 'FCM')) {
                PushNotification.hasPermission(function (data) {
                    return resolve(data.isEnabled);
                });
            }
            else if (_this.deviceType === 'iOS' && pushType === 'APNS') {
                APNSPushNotification.hasPermission(function (data) {
                    return resolve(data.isEnabled);
                });
            }
            else {
                return resolve(true);
            }
        });
    };
    NNotificationService.prototype.initializeNotifications = function (pushType) {
        var _this = this;
        //pushType = pushType ? pushType : 'FCM';
        pushType = this.getPushType(pushType);
        var push;
        // Default if for FCM
        if (pushType === 'FCM') {
            push = window['PushNotification'].init({
                android: {
                    senderID: this.firebaseSenderId
                },
                ios: {
                    alert: "true",
                    badge: "true",
                    sound: "true",
                    senderID: this.firebaseSenderId
                },
            });
        }
        // New APNS plugin init
        else if (pushType === 'APNS') {
            push = window['APNSPushNotification'].init({
                ios: {
                    alert: "true",
                    badge: "true",
                    sound: "true"
                }
            });
        }
        push.on('registration', function (data) {
            // data.registrationId
            _this.sendRegDetails(data.registrationId);
        });
        // ToDo Christy get call back function from app user to change what happens once a notification arrives
        push.on('notification', function (data) {
            window['cordova'].plugins.notification.local.schedule({
                title: data.title,
                text: data.message,
                sound: data.sound,
                at: new Date().getTime()
            });
        });
        push.on('error', function (e) {
            // e.message
            console.error(e);
        });
    };
    NNotificationService.prototype.sendRegDetails = function (registrationId) {
        this.localStorageService.setValue('registrationId', registrationId);
        var url = this.systemService.getTenantUrl() + 'notification/' + this.systemService.getVal('appName') + '/register';
        var pushType = this.getPushType(this.systemService.getVal('pushType'));
        this.http.post(url, {
            'key': this.sessionStorage.getValue('userObj')['userKey'],
            'uuid': this.localStorageService.getValue('uuid'),
            'fbregid': registrationId,
            'pushType': pushType
        }).subscribe(function (result) {
            // this.pubSubService.$pub('FBRegComp');
        }, function (error) {
            console.log(error);
        });
    };
    NNotificationService.prototype.getPushType = function (currPushType) {
        var isValidPush = typeof currPushType !== 'undefined' && this.possiblePushTypes.includes(currPushType.toUpperCase());
        var pushType = isValidPush ? currPushType.toUpperCase() : 'FCM';
        return pushType;
    };
    NNotificationService.prototype.ngOnDestroy = function () {
        this.loginSubscribe.unSubscribe();
    };
    NNotificationService = tslib_1.__decorate([
        Injectable(),
        tslib_1.__metadata("design:paramtypes", [NLocalStorageService, NPubSubService,
            HttpClient, NHTTPLoaderService])
    ], NNotificationService);
    return NNotificationService;
}());
export { NNotificationService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibi1ub3RpZmljYXRpb24uc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL25ldXRyaW5vcy1zZWVkLXNlcnZpY2VzLyIsInNvdXJjZXMiOlsic3JjL2FwcC9uZXV0cmlub3Mtc2VlZC1zZXJ2aWNlcy9uLW5vdGlmaWNhdGlvbi5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFxQixNQUFNLGVBQWUsQ0FBQztBQUM5RCxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFJcEQsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sMEJBQTBCLENBQUM7QUFDaEUsT0FBTyxLQUFLLFFBQVEsTUFBTSxVQUFVLENBQUM7QUFDckMsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBQ3BELE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUNsRCxPQUFPLEVBQUUsc0JBQXNCLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUNwRSw0Q0FBNEM7QUFDNUMsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFLNUQ7SUFZRSw4QkFBb0IsbUJBQXlDLEVBQVUsYUFBNkIsRUFDMUYsSUFBZ0IsRUFBVSxXQUErQjtRQURuRSxpQkFVQztRQVZtQix3QkFBbUIsR0FBbkIsbUJBQW1CLENBQXNCO1FBQVUsa0JBQWEsR0FBYixhQUFhLENBQWdCO1FBQzFGLFNBQUksR0FBSixJQUFJLENBQVk7UUFBVSxnQkFBVyxHQUFYLFdBQVcsQ0FBb0I7UUFabkUsaURBQWlEO1FBQ3pDLGtCQUFhLEdBQW1CLGNBQWMsQ0FBQyxXQUFXLEVBQUUsQ0FBQztRQU03RCxzQkFBaUIsR0FBYSxDQUFDLE1BQU0sRUFBQyxLQUFLLENBQUMsQ0FBQztRQU1uRCxJQUFJLENBQUMsZ0JBQWdCLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxNQUFNLENBQUMsa0JBQWtCLENBQUMs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Q0FBQyxRQUFRLENBQUMsWUFBWSxDQUFDLFdBQVcsRUFBRSxDQUFDLENBQUM7UUFDckgsSUFBSSxRQUFRLEdBQUcsV0FBVyxDQUFDLENBQUMsQ0FBQyxZQUFZLENBQUMsV0FBVyxFQUFFLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQztRQUNoRSxPQUFPLFFBQVEsQ0FBQztJQUNsQixDQUFDO0lBRUQsMENBQVcsR0FBWDtRQUNFLElBQUksQ0FBQyxjQUFjLENBQUMsV0FBVyxFQUFFLENBQUM7SUFDcEMsQ0FBQztJQS9LVSxvQkFBb0I7UUFEaEMsVUFBVSxFQUFFO2lEQWE4QixvQkFBb0IsRUFBeUIsY0FBYztZQUNwRixVQUFVLEVBQXVCLGtCQUFrQjtPQWJ4RCxvQkFBb0IsQ0FnTGhDO0lBQUQsMkJBQUM7Q0FBQSxBQWhMRCxJQWdMQztTQWhMWSxvQkFBb0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBPbkluaXQsIE9uRGVzdHJveSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgTlN5c3RlbVNlcnZpY2UgfSBmcm9tICcuL24tc3lzdGVtLnNlcnZpY2UnO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSB9IGZyb20gJ3J4anMnO1xuZGVjbGFyZSB2YXIgUHVzaE5vdGlmaWNhdGlvbjogYW55O1xuZGVjbGFyZSB2YXIgQVBOU1B1c2hOb3RpZmljYXRpb246IGFueTtcbmltcG9ydCB7IE5Mb2NhbFN0b3JhZ2VTZXJ2aWNlIH0gZnJvbSAnLi9uLWxvY2FsU3RvcmFnZS5zZXJ2aWNlJztcbmltcG9ydCAqIGFzIGZpcmViYXNlIGZyb20gJ2ZpcmViYXNlJztcbmltcG9ydCB7IE5QdWJTdWJTZXJ2aWNlIH0gZnJvbSAnLi9uLXB1YlN1Yi5zZXJ2aWNlJztcbmltcG9ydCB7IEh0dHBDbGllbnQgfSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XG5pbXBvcnQgeyBOU2Vzc2lvblN0b3JhZ2VTZXJ2aWNlIH0gZnJvbSAnLi9uLXNlc3Npb25TdG9yYWdlLnNlcnZpY2UnO1xuLy8gaW1wb3J0IHsgUm91dGVyIH0gZnJvbSAnQGFuZ3VsYXIvcm91dGVyJztcbmltcG9ydCB7IE5IVFRQTG9hZGVyU2VydmljZSB9IGZyb20gJy4vbi1IVFRQTG9hZGVyLnNlcnZpY2UnO1xuaW1wb3J0IHsgZW52aXJvbm1lbnQgfSBmcm9tICcuLi8uLi9lbnZpcm9ubWVudHMvZW52aXJvbm1lbnQucHJvZCc7XG5cblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIE5Ob3RpZmljYXRpb25TZXJ2aWNlIHtcbiAgLy8gcHJpdmF0ZSBzdGF0aWMgaW5zdGFuY2U6IE5Ob3RpZmljYXRpb25TZXJ2aWNlO1xuICBwcml2YXRlIHN5c3RlbVNlcnZpY2U6IE5TeXN0ZW1TZXJ2aWNlID0gTlN5c3RlbVNlcnZpY2UuZ2V0SW5zdGFuY2UoKTtcbiAgcHJpdmF0ZSBmaXJlYmFzZVNlbmRlcklkOiBzdHJpbmc7XG4gIHByaXZhdGUgaXNOb3RpZmljYXRpb25FbmFibGVkOiBib29sZWFuO1xuICBwcml2YXRlIGRldmljZVR5cGU7IHN0cmluZztcbiAgcHJpdmF0ZSByZXNEZXRhaWxzO1xuICBwcml2YXRlIGRldmljZVVVSUQ6IHN0cmluZztcbiAgcHJpdmF0ZSBwb3NzaWJsZVB1c2hUeXBlczogc3RyaW5nW10gPSBbJ0FQTlMnLCdGQ00nXTtcbiAgbG9naW5TdWJzY3JpYmU7XG4gIHNlc3Npb25TdG9yYWdlOiBOU2Vzc2lvblN0b3JhZ2VTZXJ2aWNlO1xuICBhcHBOYW1lO1xuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGxvY2FsU3RvcmFnZVNlcnZpY2U6IE5Mb2NhbFN0b3JhZ2VTZXJ2aWNlLCBwcml2YXRlIHB1YlN1YlNlcnZpY2U6IE5QdWJTdWJTZXJ2aWNlLFxuICAgIHByaXZhdGUgaHR0cDogSHR0cENsaWVudCwgcHJpdmF0ZSBiSHR0cExvYWRlcjogTkhUVFBMb2FkZXJTZXJ2aWNlKSB7XG4gICAgdGhpcy5maXJlYmFzZVNlbmRlcklkID0gdGhpcy5zeXN0ZW1TZXJ2aWNlLmdldFZhbCgnZmlyZWJhc2VTZW5kZXJJZCcpO1xuICAgIHRoaXMuaXNOb3RpZmljYXRpb25FbmFibGVkID0gdGhpcy5zeXN0ZW1TZXJ2aWNlLmdldFZhbCgnaXNOb3RpZmljYXRpb25FbmFibGVkJyk7XG4gICAgdGhpcy5hcHBOYW1lID0gdGhpcy5zeXN0ZW1TZXJ2aWNlLmdldFZhbCgnYXBwTmFtZScpO1xuICAgIHRoaXMuZGV2aWNlVHlwZSA9IHRoaXMuc3lzdGVtU2VydmljZS5kZXZpY2VUeXBlO1xuICAgIHRoaXMuc2Vzc2lvblN0b3JhZ2UgPSBuZXcgTlNlc3Npb25TdG9yYWdlU2VydmljZSgpO1xuICAgIHRoaXMubG9naW5TdWJzY3JpYmUgPSB0aGlzLnB1YlN1YlNlcnZpY2UuJHN1YignZmlyZWJhc2VSZWdpc3RlcicsICgpID0+IHtcbiAgICAgIHRoaXMuZW5hYmxlTm90aWZpY2F0aW9uKCk7XG4gICAgfSlcbiAgfVxuXG4gIG5nT25Jbml0KCkge1xuICB9XG5cblxuICBlbmFibGVOb3RpZmljYXRpb24oKSB7XG4gICAgbGV0IHB1c2hUeXBlID0gdGhpcy5nZXRQdXNoVHlwZSh0aGlzLnN5c3RlbVNlcnZpY2UuZ2V0VmFsKCdwdXNoVHlwZScpKTtcbiAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdkZXZpY2VyZWFkeScsIGV2ZW50ID0+IHtcbiAgICAgIGlmICh0aGlzLmlzTm90aWZpY2F0aW9uRW5hYmxlZCkge1xuICAgICAgICBpZiAodGhpcy5kZXZpY2VUeXBlICYmIHRoaXMuZGV2aWNlVHlwZSAhPSAnYnJvd3NlcicpIHtcbiAgICAgICAgICB0aGlzLmRldmljZVR5cGUgPSB0aGlzLnN5c3RlbVNlcnZpY2UuZGV2aWNlVHlwZTtcbiAgICAgICAgICB0aGlzLmNoZWNrUGVybWlzc2lvbihwdXNoVHlwZSkudGhlbihyZXMgPT4ge1xuICAgICAgICAgICAgaWYgKHJlcykge1xuICAgICAgICAgICAgICB0aGlzLmluaXRpYWxpemVOb3RpZmljYXRpb25zKHB1c2hUeXBlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0pO1xuICAgIGlmICh0aGlzLmlzTm90aWZpY2F0aW9uRW5hYmxlZCAmJiBwdXNoVHlwZSAhPT0gJ0FQTlMnKSB7XG4gICAgICBpZiAodGhpcy5kZXZpY2VUeXBlICYmIHRoaXMuZGV2aWNlVHlwZSA9PSAnYnJvd3NlcicgJiYgd2luZG93WydOb3RpZmljYXRpb24nXSkge1xuICAgICAgICB0aGlzLmluaXRpYWxpc2VXZWJQdXNoKCk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgaW5pdGlhbGlzZVdlYlB1c2goKSB7XG4gICAgY29uc3QgX190aGlzID0gdGhpcztcbiAgICBjb25zdCBtZXNzYWdpbmcgPSBmaXJlYmFzZS5tZXNzYWdpbmcoKTtcblxuICAgIE5vdGlmaWNhdGlvbi5yZXF1ZXN0UGVybWlzc2lvbigpXG4gICAgICAudGhlbihmdW5jdGlvbiAoKSB7XG4gICAgICAgIHJldHVybiBtZXNzYWdpbmcuZ2V0VG9rZW4oKTtcbiAgICAgIH0pXG4gICAgICAudGhlbihmdW5jdGlvbiAodG9rZW4pIHtcbiAgICAgICAgaWYgKHRva2VuKSB7XG4gICAgICAgICAgX190aGlzLnNlbmRSZWdEZXRhaWxzKHRva2VuKTtcbiAgICAgICAgfVxuICAgICAgfSlcbiAgICAgIC5jYXRjaChmdW5jdGlvbiAoZXJyKSB7XG4gICAgICAgIF9fdGhpcy5iSHR0cExvYWRlci5hbGVydEVycm9yKGVycik7XG4gICAgICB9KTtcblxuICAgIG1lc3NhZ2luZy5vbk1lc3NhZ2UoZnVuY3Rpb24gKHBheWxvYWQpIHtcbiAgICAgIGlmIChwYXlsb2FkWydub3RpZmljYXRpb24nXSkge1xuICAgICAgICBsZXQgbm90aWZpY2F0aW9uT2JqID0gcGF5bG9hZFsnbm90aWZpY2F0aW9uJ107XG4gICAgICAgIGxldCBvcHRpb25zID0ge1xuICAgICAgICAgIGJvZHk6IG5vdGlmaWNhdGlvbk9iai5ib2R5LFxuICAgICAgICAgIGljb246IG5vdGlmaWNhdGlvbk9iai5pY29uXG4gICAgICAgIH1cbiAgICAgICAgLy8gY3JlYXRpbmcgYSBuYXRpdmUgYnJvd3NlciBtZXNzYWdlXG4gICAgICAgIGxldCBub3RpZmljYXRpb25VSSA9IG5ldyBOb3RpZmljYXRpb24obm90aWZpY2F0aW9uT2JqLnRpdGxlLCBvcHRpb25zKTtcbiAgICAgICAgbm90aWZpY2F0aW9uVUkub25jbGljayA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICB3aW5kb3cuZm9jdXMoKTsgLy8gd2luZG93IGlzIGZvY3VzZWQgd2hlbiB0aGUgdXNlciBjbGlja3MgdGhlIG5vdGlmaWNhdGlvbiB1c2luZyB0aGlzXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIGNoZWNrUGVybWlzc2lvbihwdXNoVHlwZT8pIHtcbiAgICAvLyBBbmRyb2lkICYgaU9TIG9ubHlcbiAgICAvLyBDaGVja3Mgd2hldGhlciB0aGUgcHVzaCBub3RpZmljYXRpb24gcGVybWlzc2lvbiBoYXMgYmVlbiBncmFudGVkLlxuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4ge1xuICAgICAgcHVzaFR5cGUgPSB0aGlzLmdldFB1c2hUeXBlKHB1c2hUeXBlKTtcbiAgICAgIGlmICgodGhpcy5kZXZpY2VUeXBlID09PSAnQW5kcm9pZCcgfHwgdGhpcy5kZXZpY2VUeXBlID09PSAnaU9TJykgJiYgKHB1c2hUeXBlID09PSAnRkNNJyApKSB7XG4gICAgICAgIFB1c2hOb3RpZmljYXRpb24uaGFzUGVybWlzc2lvbihmdW5jdGlvbiAoZGF0YSkge1xuICAgICAgICAgIHJldHVybiByZXNvbHZlKGRhdGEuaXNFbmFibGVkKTtcbiAgICAgICAgfSk7XG4gICAgICB9IGVsc2UgaWYgKHRoaXMuZGV2aWNlVHlwZSA9PT0gJ2lPUycgJiYgcHVzaFR5cGUgPT09ICdBUE5TJykge1xuICAgICAgICAgQVBOU1B1c2hOb3RpZmljYXRpb24uaGFzUGVybWlzc2lvbihmdW5jdGlvbiAoZGF0YSkge1xuICAgICAgICAgIHJldHVybiByZXNvbHZlKGRhdGEuaXNFbmFibGVkKTtcbiAgICAgICAgfSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4gcmVzb2x2ZSh0cnVlKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIGluaXRpYWxpemVOb3RpZmljYXRpb25zKHB1c2hUeXBlPykge1xuICAgIC8vcHVzaFR5cGUgPSBwdXNoVHlwZSA/IHB1c2hUeXBlIDogJ0ZDTSc7XG4gICAgcHVzaFR5cGUgPSB0aGlzLmdldFB1c2hUeXBlKHB1c2hUeXBlKTtcblxuICAgIGxldCBwdXNoO1xuICAgIC8vIERlZmF1bHQgaWYgZm9yIEZDTVxuICAgIGlmIChwdXNoVHlwZSA9PT0gJ0ZDTScpIHtcbiAgICAgIHB1c2ggPSB3aW5kb3dbJ1B1c2hOb3RpZmljYXRpb24nXS5pbml0KHtcbiAgICAgICAgYW5kcm9pZDoge1xuICAgICAgICAgIHNlbmRlcklEOiB0aGlzLmZpcmViYXNlU2VuZGVySWRcbiAgICAgICAgfSxcbiAgICAgICAgaW9zOiB7XG4gICAgICAgICAgYWxlcnQ6IFwidHJ1ZVwiLFxuICAgICAgICAgIGJhZGdlOiBcInRydWVcIixcbiAgICAgICAgICBzb3VuZDogXCJ0cnVlXCIsXG4gICAgICAgICAgc2VuZGVySUQ6IHRoaXMuZmlyZWJhc2VTZW5kZXJJZFxuICAgICAgICB9LFxuICAgICAgfSk7XG4gICAgfVxuICAgIC8vIE5ldyBBUE5TIHBsdWdpbiBpbml0XG4gICAgZWxzZSBpZiAocHVzaFR5cGUgPT09ICdBUE5TJykge1xuICAgICAgcHVzaCA9IHdpbmRvd1snQVBOU1B1c2hOb3RpZmljYXRpb24nXS5pbml0KHtcbiAgICAgICAgaW9zOiB7XG4gICAgICAgICAgYWxlcnQ6IFwidHJ1ZVwiLFxuICAgICAgICAgIGJhZGdlOiBcInRydWVcIixcbiAgICAgICAgICBzb3VuZDogXCJ0cnVlXCJcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfVxuICAgIHB1c2gub24oJ3JlZ2lzdHJhdGlvbicsIChkYXRhKSA9PiB7XG4gICAgICAvLyBkYXRhLnJlZ2lzdHJhdGlvbklkXG4gICAgICB0aGlzLnNlbmRSZWdEZXRhaWxzKGRhdGEucmVnaXN0cmF0aW9uSWQpO1xuICAgIH0pO1xuXG4gICAgLy8gVG9EbyBDaHJpc3R5IGdldCBjYWxsIGJhY2sgZnVuY3Rpb24gZnJvbSBhcHAgdXNlciB0byBjaGFuZ2Ugd2hhdCBoYXBwZW5zIG9uY2UgYSBub3RpZmljYXRpb24gYXJyaXZlc1xuICAgIHB1c2gub24oJ25vdGlmaWNhdGlvbicsIChkYXRhKSA9PiB7XG4gICAgICB3aW5kb3dbJ2NvcmRvdmEnXS5wbHVnaW5zLm5vdGlmaWNhdGlvbi5sb2NhbC5zY2hlZHVsZSh7XG4gICAgICAgIHRpdGxlOiBkYXRhLnRpdGxlLFxuICAgICAgICB0ZXh0OiBkYXRhLm1lc3NhZ2UsXG4gICAgICAgIHNvdW5kOiBkYXRhLnNvdW5kLFxuICAgICAgICBhdDogbmV3IERhdGUoKS5nZXRUaW1lKClcbiAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgcHVzaC5vbignZXJyb3InLCAoZSkgPT4ge1xuICAgICAgLy8gZS5tZXNzYWdlXG4gICAgICBjb25zb2xlLmVycm9yKGUpO1xuICAgIH0pO1xuICB9XG5cbiAgc2VuZFJlZ0RldGFpbHMocmVnaXN0cmF0aW9uSWQpIHtcbiAgICB0aGlzLmxvY2FsU3RvcmFnZVNlcnZpY2Uuc2V0VmFsdWUoJ3JlZ2lzdHJhdGlvbklkJywgcmVnaXN0cmF0aW9uSWQpO1xuICAgIHZhciB1cmwgPSB0aGlzLnN5c3RlbVNlcnZpY2UuZ2V0VGVuYW50VXJsKCkgKyAnbm90aWZpY2F0aW9uLycgKyB0aGlzLnN5c3RlbVNlcnZpY2UuZ2V0VmFsKCdhcHBOYW1lJykgKyAnL3JlZ2lzdGVyJztcbiAgICBsZXQgcHVzaFR5cGUgPSB0aGlzLmdldFB1c2hUeXBlKHRoaXMuc3lzdGVtU2VydmljZS5nZXRWYWwoJ3B1c2hUeXBlJykpO1xuICAgIHRoaXMuaHR0cC5wb3N0KHVybCwge1xuICAgICAgJ2tleSc6IHRoaXMuc2Vzc2lvblN0b3JhZ2UuZ2V0VmFsdWUoJ3VzZXJPYmonKVsndXNlcktleSddLFxuICAgICAgJ3V1aWQnOiB0aGlzLmxvY2FsU3RvcmFnZVNlcnZpY2UuZ2V0VmFsdWUoJ3V1aWQnKSwgXG4gICAgICAnZmJyZWdpZCc6IHJlZ2lzdHJhdGlvbklkLFxuICAgICAgJ3B1c2hUeXBlJzogcHVzaFR5cGVcbiAgICB9KS5zdWJzY3JpYmUocmVzdWx0ID0+IHtcbiAgICAgIC8vIHRoaXMucHViU3ViU2VydmljZS4kcHViKCdGQlJlZ0NvbXAnKTtcbiAgICB9LCBlcnJvciA9PiB7XG4gICAgICBjb25zb2xlLmxvZyhlcnJvcik7XG4gICAgfSlcbiAgfVxuXG4gIGdldFB1c2hUeXBlIChjdXJyUHVzaFR5cGUpIHtcbiAgICBsZXQgaXNWYWxpZFB1c2ggPSB0eXBlb2YgY3VyclB1c2hUeXBlICE9PSAndW5kZWZpbmVkJyAmJiB0aGlzLnBvc3NpYmxlUHVzaFR5cGVzLmluY2x1ZGVzKGN1cnJQdXNoVHlwZS50b1VwcGVyQ2FzZSgpKTtcbiAgICBsZXQgcHVzaFR5cGUgPSBpc1ZhbGlkUHVzaCA/IGN1cnJQdXNoVHlwZS50b1VwcGVyQ2FzZSgpIDogJ0ZDTSc7XG4gICAgcmV0dXJuIHB1c2hUeXBlO1xuICB9XG5cbiAgbmdPbkRlc3Ryb3koKSB7XG4gICAgdGhpcy5sb2dpblN1YnNjcmliZS51blN1YnNjcmliZSgpO1xuICB9XG59XG4iXX0=