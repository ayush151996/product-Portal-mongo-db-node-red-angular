import * as tslib_1 from "tslib";
import { Injectable, Injector } from '@angular/core';
import { HttpHeaders, HttpErrorResponse, HttpClient } from '@angular/common/http';
import { BehaviorSubject, throwError } from 'rxjs';
import { NHTTPLoaderService } from './n-HTTPLoader.service';
import { NSystemService } from './n-system.service';
import { NSessionStorageService } from './n-sessionStorage.service';
import { NLocalStorageService } from './n-localStorage.service';
import { NTokenService } from './n-token.service';
import { NPubSubService } from './n-pubSub.service';
import { timeout, catchError, finalize, switchMap, filter, take } from 'rxjs/operators';
let NHttpService = class NHttpService {
    constructor(nHTTPLoader, inj, nLocalStorageService, nTokenService) {
        this.nHTTPLoader = nHTTPLoader;
        this.inj = inj;
        this.nLocalStorageService = nLocalStorageService;
        this.nTokenService = nTokenService;
        this.timeout = 90000;
        this.isRefreshingToken = false;
        this.tokenSubject = new BehaviorSubject(null);
        this.systemService = NSystemService.getInstance();
        this.nSessionStorage = new NSessionStorageService();
        this.appProperties = this.systemService.getVal('properties');
        this.nPubSubService = new NPubSubService();
    }
    intercept(req, next) {
        this.requestInterceptor();
        // Pass on the cloned request instead of the original request.
        return next.handle(this.requestOptions(req))
            .pipe(timeout(this.timeout), catchError(error => this.onCatch(error, req, next)), finalize(() => {
            this.onFinally();
        }));
    }
    updateToken(error, req, next) {
        if (this.appProperties.appAuthenticationStrategy === 'activeDirectory' ||
            this.appProperties.appAuthenticationStrategy === 'localAuth') {
            if (!this.isRefreshingToken) {
                this.isRefreshingToken = true;
                // Reset here so that the following requests wait until the token
                // comes back from the refreshToken call.
                this.tokenSubject.next(null);
                return this.refreshToken()
                    .pipe(switchMap((tokensObj) => {
                    if (tokensObj) {
                        this.nTokenService.updateTokens(tokensObj);
                        const newToken = tokensObj['accessToken'];
                        this.tokenSubject.next(newToken);
                        return next.handle(this.requestOptions(req));
                    }
                    return throwError(new Error('Can\'t refresh the token'));
                }), catchError(err => this.onCatchError(err)), finalize(() => this.isRefreshingToken = false));
            }
            else {
                return this.tokenSubject.pipe(filter(token => token != null), take(1), switchMap(token => next.handle(this.requestOptions(req))));
            }
        }
        else {
            return this.onCatchError(error);
        }
    }
    refreshToken() {
        const http = this.inj.get(HttpClient);
        const appProperties = this.systemService.getVal('properties');
        const refreshUrl = this.systemService.getAuthUrl() + appProperties.appName + '/refresh';
        const body = {
            'platformDetails': this.systemService.getPlatformDetails(this.systemService.checkDevice()),
            'userKey': this.nSessionStorage.getValue('userObj')['userKey'],
            'refreshToken': this.nSessionStorage.getValue('refreshToken')
        };
        body.platformDetails['uuid'] = this.nLocalStorageService.getValue('uuid');
        return http.post(refreshUrl, body);
    }
    /**
     * Request options.
     * @param options
     * @returns HttpRequest
     */
    requestOptions(req) {
        let headers = req.headers;
        if (req.headers == null) {
            headers = new HttpHeaders();
        }
        req = req.clone({
            url: this.getFullUrl(req.url),
            headers: headers
        });
        const baseUrl = NSystemService.getInstance().getVal('baseUrl');
        const isArt = (baseUrl !== '' && req.url.includes(baseUrl));
        return isArt ? this.addDefaultHeaders(req) : req;
    }
    /**
    * Default options.
    * @param options
    * @returns HttpHeadedrs
    */
    addDefaultHeaders(req) {
        /**
         * TODO: Add all default Headers over here
         */
        if (!req.headers.has('Access-Control-Allow-Origin')) {
            req.headers = req.headers.set('Access-Control-Allow-Origin', '*');
        }
        if (!req.headers.has('Content-Type')) {
            req.headers = req.headers.set('Content-Type', 'application/json');
        }
        else if (req.headers.has('Content-Type') && (req.headers.get('Content-Type') === 'no-content')) {
            req.headers = req.headers.delete('Content-Type');
        }
        if (!req.headers.has('Accept')) {
            req.headers = req.headers.set('Accept', 'application/json');
        }
        if (!req.headers.has('Authorization')) {
            this.appProperties = this.systemService.getVal('properties');
            if (this.appProperties && this.appProperties.appAuthenticationStrategy === 'basicAuth') {
                let username, password;
                if (this.appProperties.basicAuthUser && this.appProperties.basicAuthPassword) {
                    username = this.appProperties.basicAuthUser;
                    password = this.appProperties.basicAuthPassword;
                }
                else {
                    username = "bhive-art-proxyuser";
                    password = "password";
                    console.warn("Authentication strategy: Basic Auth. basicAuthUser and basicAuthPassword are not configured in environment. Setting default values.");
                }
                req.headers = req.headers.set('Authorization', 'Basic ' + btoa(username + ":" + password));
            }
            else if (this.appProperties && (this.appProperties.appAuthenticationStrategy === 'activeDirectory' ||
                this.appProperties.appAuthenticationStrategy === 'localAuth')) {
                if (this.nSessionStorage.getValue('accessToken')) {
                    req.headers = req.headers.set('Authorization', 'Bearer ' + this.nSessionStorage.getValue('accessToken'));
                }
            }
        }
        return req;
    }
    /**
     * Build API url.
     * @param url
     * @returns string
     */
    getFullUrl(url) {
        // return full URL to API here
        return url;
    }
    /**
     * Request interceptor.
     */
    requestInterceptor() {
        this.nHTTPLoader.isHTTPRequestInProgress(true);
    }
    /**
     * Response interceptor.
     */
    responseInterceptor() {
        this.nHTTPLoader.isHTTPRequestInProgress(false);
    }
    /**
      * Error handler.
      * @param error
      * @param caught
      * @returns ErrorObservable
      */
    onCatch(error, req, next) {
        if (error instanceof HttpErrorResponse) {
            if (error.status === 403 && error.error.message === 'jwt expired') {
                return this.updateToken(error, req, next);
            }
            else {
                return this.onSubscribeError(error);
            }
        }
        else {
            return this.onSubscribeError(error);
        }
    }
    /**
     * onSubscribeError
     * @param error
     */
    onSubscribeError(err) {
        this.nHTTPLoader.alertError(err);
        return this.onCatchError(err);
    }
    /**
     * onFinally
     */
    onFinally() {
        this.responseInterceptor();
    }
    onCatchError(error) {
        return throwError(error);
    }
};
NHttpService = tslib_1.__decorate([
    Injectable(),
    tslib_1.__metadata("design:paramtypes", [NHTTPLoaderService, Injector,
        NLocalStorageService, NTokenService])
], NHttpService);
export { NHttpService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibi1IVFRQLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9uZXV0cmlub3Mtc2VlZC1zZXJ2aWNlcy8iLCJzb3VyY2VzIjpbInNyYy9hcHAvbmV1dHJpbm9zLXNlZWQtc2VydmljZXMvbi1IVFRQLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3JELE9BQU8sRUFLTCxXQUFXLEVBRVgsaUJBQWlCLEVBQ2pCLFVBQVUsRUFDWCxNQUFNLHNCQUFzQixDQUFDO0FBQzlCLE9BQU8sRUFBYyxlQUFlLEVBQUUsVUFBVSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQy9ELE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBQzVELE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUNwRCxPQUFPLEVBQUUsc0JBQXNCLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUNwRSxPQUFPLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUNoRSxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDbEQsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBQ3BELE9BQU8sRUFBRSxPQUFPLEVBQUUsVUFBVSxFQUFFLFFBQVEsRUFBRSxTQUFTLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBR3hGLElBQWEsWUFBWSxHQUF6QixNQUFhLFlBQVk7SUFTdkIsWUFBb0IsV0FBK0IsRUFBVSxHQUFhLEVBQ2hFLG9CQUEwQyxFQUFVLGFBQTRCO1FBRHRFLGdCQUFXLEdBQVgsV0FBVyxDQUFvQjtRQUFVLFFBQUcsR0FBSCxHQUFHLENBQVU7UUFDaEUseUJBQW9CLEdBQXBCLG9CQUFvQixDQUFzQjtRQUFVLGtCQUFhLEdBQWIsYUFBYSxDQUFlO1FBVDFGLFlB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QjtRQUM3QyxJQUFJLENBQUMsV0FBVyxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUNqQyxPQUFPLElBQUksQ0FBQyxZQUFZLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDaEMsQ0FBQztJQUNEOztPQUVHO0lBQ0ssU0FBUztRQUNmLElBQUksQ0FBQyxtQkFBbUIsRUFBRSxDQUFDO0lBQzdCLENBQUM7SUFFTyxZQUFZLENBQUMsS0FBd0I7UUFDM0MsT0FBTyxVQUFVLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDM0IsQ0FBQztDQUVGLENBQUE7QUE5TVksWUFBWTtJQUR4QixVQUFVLEVBQUU7NkNBVXNCLGtCQUFrQixFQUFlLFFBQVE7UUFDMUMsb0JBQW9CLEVBQXlCLGFBQWE7R0FWL0UsWUFBWSxDQThNeEI7U0E5TVksWUFBWSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsIEluamVjdG9yIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQge1xuICBIdHRwRXZlbnQsXG4gIEh0dHBJbnRlcmNlcHRvcixcbiAgSHR0cEhhbmRsZXIsXG4gIEh0dHBSZXF1ZXN0LFxuICBIdHRwSGVhZGVycyxcbiAgSHR0cFJlc3BvbnNlLFxuICBIdHRwRXJyb3JSZXNwb25zZSxcbiAgSHR0cENsaWVudFxufSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBCZWhhdmlvclN1YmplY3QsIHRocm93RXJyb3IgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IE5IVFRQTG9hZGVyU2VydmljZSB9IGZyb20gJy4vbi1IVFRQTG9hZGVyLnNlcnZpY2UnO1xuaW1wb3J0IHsgTlN5c3RlbVNlcnZpY2UgfSBmcm9tICcuL24tc3lzdGVtLnNlcnZpY2UnO1xuaW1wb3J0IHsgTlNlc3Npb25TdG9yYWdlU2VydmljZSB9IGZyb20gJy4vbi1zZXNzaW9uU3RvcmFnZS5zZXJ2aWNlJztcbmltcG9ydCB7IE5Mb2NhbFN0b3JhZ2VTZXJ2aWNlIH0gZnJvbSAnLi9uLWxvY2FsU3RvcmFnZS5zZXJ2aWNlJztcbmltcG9ydCB7IE5Ub2tlblNlcnZpY2UgfSBmcm9tICcuL24tdG9rZW4uc2VydmljZSc7XG5pbXBvcnQgeyBOUHViU3ViU2VydmljZSB9IGZyb20gJy4vbi1wdWJTdWIuc2VydmljZSc7XG5pbXBvcnQgeyB0aW1lb3V0LCBjYXRjaEVycm9yLCBmaW5hbGl6ZSwgc3dpdGNoTWFwLCBmaWx0ZXIsIHRha2UgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBOSHR0cFNlcnZpY2Uge1xuICB0aW1lb3V0ID0gOTAwMDA7XG4gIHN5c3RlbVNlcnZpY2U7XG4gIG5TZXNzaW9uU3RvcmFnZTtcbiAgYXBwUHJvcGVydGllcztcbiAgaXNSZWZyZXNoaW5nVG9rZW4gPSBmYWxzZTtcbiAgblB1YlN1YlNlcnZpY2U7XG4gIHRva2VuU3ViamVjdDogQmVoYXZpb3JTdWJqZWN0PHN0cmluZz4gPSBuZXcgQmVoYXZpb3JTdWJqZWN0PHN0cmluZz4obnVsbCk7XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSBuSFRUUExvYWRlcjogTkhUVFBMb2FkZXJTZXJ2aWNlLCBwcml2YXRlIGluajogSW5qZWN0b3IsXG4gICAgcHJpdmF0ZSBuTG9jYWxTdG9yYWdlU2VydmljZTogTkxvY2FsU3RvcmFnZVNlcnZpY2UsIHByaXZhdGUgblRva2VuU2VydmljZTogTlRva2VuU2VydmljZSkge1xuICAgIHRoaXMuc3lzdGVtU2VydmljZSA9IE5TeXN0ZW1TZXJ2aWNlLmdldEluc3RhbmNlKCk7XG4gICAgdGhpcy5uU2Vzc2lvblN0b3JhZ2UgPSBuZXcgTlNlc3Npb25TdG9yYWdlU2VydmljZSgpO1xuICAgIHRoaXMuYXBwUHJvcGVydGllcyA9IHRoaXMuc3lzdGVtU2VydmljZS5nZXRWYWwoJ3Byb3BlcnRpZXMnKTtcbiAgICB0aGlzLm5QdWJTdWJTZXJ2aWNlID0gbmV3IE5QdWJTdWJTZXJ2aWNlKCk7XG4gIH1cblxuICBpbnRlcmNlcHQocmVxOiBIdHRwUmVxdWVzdDxhbnk+LCBuZXh0OiBIdHRwSGFuZGxlcik6IE9ic2VydmFibGU8SHR0cEV2ZW50PGFueT4+IHtcbiAgICB0aGlzLnJlcXVlc3RJbnRlcmNlcHRvcigpO1xuXG4gICAgLy8gUGFzcyBvbiB0aGUgY2xvbmVkIHJlcXVlc3QgaW5zdGVhZCBvZiB0aGUgb3JpZ2luYWwgcmVxdWVzdC5cbiAgICByZXR1cm4gbmV4dC5oYW5kbGUodGhpcy5yZXF1ZXN0T3B0aW9ucyhyZXEpKVxuICAgICAgLnBpcGUodGltZW91dCh0aGlzLnRpbWVvdXQpXG4gICAgICAgICwgY2F0Y2hFcnJvcihlcnJvciA9PiB0aGlzLm9uQ2F0Y2goZXJyb3IsIHJlcSwgbmV4dCkpXG4gICAgICAgICwgZmluYWxpemUoKCkgPT4ge1xuICAgICAgICAgIHRoaXMub25GaW5hbGx5KCk7XG4gICAgICAgIH0pKTtcbiAgfVxuXG4gIHVwZGF0ZVRva2VuKGVycm9yOiBIdHRwRXJyb3JSZXNwb25zZSwgcmVxOiBIdHRwUmVxdWVzdDxhbnk+LCBuZXh0OiBIdHRwSGFuZGxlcik6IGFueSB7XG4gICAgaWYgKHRoaXMuYXBwUHJvcGVydGllcy5hcHBBdXRoZW50aWNhdGlvblN0cmF0ZWd5ID09PSAnYWN0aXZlRGlyZWN0b3J5JyB8fFxuICAgICAgdGhpcy5hcHBQcm9wZXJ0aWVzLmFwcEF1dGhlbnRpY2F0aW9uU3RyYXRlZ3kgPT09ICdsb2NhbEF1dGgnKSB7XG4gICAgICBpZiAoIXRoaXMuaXNSZWZyZXNoaW5nVG9rZW4pIHtcbiAgICAgICAgdGhpcy5pc1JlZnJlc2hpbmdUb2tlbiA9IHRydWU7XG5cbiAgICAgICAgLy8gUmVzZXQgaGVyZSBzbyB0aGF0IHRoZSBmb2xsb3dpbmcgcmVxdWVzdHMgd2FpdCB1bnRpbCB0aGUgdG9rZW5cbiAgICAgICAgLy8gY29tZXMgYmFjayBmcm9tIHRoZSByZWZyZXNoVG9rZW4gY2FsbC5cbiAgICAgICAgdGhpcy50b2tlblN1YmplY3QubmV4dChudWxsKTtcblxuICAgICAgICByZXR1cm4gdGhpcy5yZWZyZXNoVG9rZW4oKVxuICAgICAgICAgIC5waXBlKFxuICAgICAgICAgICAgc3dpdGNoTWFwKCh0b2tlbnNPYmo6IE9iamVjdCkgPT4ge1xuICAgICAgICAgICAgICBpZiAodG9rZW5zT2JqKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5uVG9rZW5TZXJ2aWNlLnVwZGF0ZVRva2Vucyh0b2tlbnNPYmopO1xuICAgICAgICAgICAgICAgIGNvbnN0IG5ld1Rva2VuID0gdG9rZW5zT2JqWydhY2Nlc3NUb2tlbiddO1xuICAgICAgICAgICAgICAgIHRoaXMudG9rZW5TdWJqZWN0Lm5leHQobmV3VG9rZW4pO1xuICAgICAgICAgICAgICAgIHJldHVybiBuZXh0LmhhbmRsZSh0aGlzLnJlcXVlc3RPcHRpb25zKHJlcSkpO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIHJldHVybiB0aHJvd0Vycm9yKG5ldyBFcnJvcignQ2FuXFwndCByZWZyZXNoIHRoZSB0b2tlbicpKTtcbiAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgY2F0Y2hFcnJvcihlcnIgPT4gdGhpcy5vbkNhdGNoRXJyb3IoZXJyKSksXG4gICAgICAgICAgICBmaW5hbGl6ZSgoKSA9PiB0aGlzLmlzUmVmcmVzaGluZ1Rva2VuID0gZmFsc2UpXG4gICAgICAgICAgKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiB0aGlzLnRva2VuU3ViamVjdC5waXBlKFxuICAgICAgICAgIGZpbHRlcih0b2tlbiA9PiB0b2tlbiAhPSBudWxsKSxcbiAgICAgICAgICB0YWtlKDEpLFxuICAgICAgICAgIHN3aXRjaE1hcCh0b2tlbiA9PiBuZXh0LmhhbmRsZSh0aGlzLnJlcXVlc3RPcHRpb25zKHJlcSkpKVxuICAgICAgICApO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gdGhpcy5vbkNhdGNoRXJyb3IoZXJyb3IpO1xuICAgIH1cbiAgfVxuXG4gIHJlZnJlc2hUb2tlbigpIHtcbiAgICBjb25zdCBodHRwID0gdGhpcy5pbmouZ2V0KEh0dHBDbGllbnQpO1xuICAgIGNvbnN0IGFwcFByb3BlcnRpZXMgPSB0aGlzLnN5c3RlbVNlcnZpY2UuZ2V0VmFsKCdwcm9wZXJ0aWVzJyk7XG4gICAgY29uc3QgcmVmcmVzaFVybCA9IHRoaXMuc3lzdGVtU2VydmljZS5nZXRBdXRoVXJsKCkgKyBhcHBQcm9wZXJ0aWVzLmFwcE5hbWUgKyAnL3JlZnJlc2gnO1xuICAgIGNvbnN0IGJvZHkgPSB7XG4gICAgICAncGxhdGZvcm1EZXRhaWxzJzogdGhpcy5zeXN0ZW1TZXJ2aWNlLmdldFBsYXRmb3JtRGV0YWlscyh0aGlzLnN5c3RlbVNlcnZpY2UuY2hlY2tEZXZpY2UoKSksXG4gICAgICAndXNlcktleSc6IHRoaXMublNlc3Npb25TdG9yYWdlLmdldFZhbHVlKCd1c2VyT2JqJylbJ3VzZXJLZXknXSxcbiAgICAgICdyZWZyZXNoVG9rZW4nOiB0aGlzLm5TZXNzaW9uU3RvcmFnZS5nZXRWYWx1ZSgncmVmcmVzaFRva2VuJylcbiAgICB9O1xuICAgIGJvZHkucGxhdGZvcm1EZXRhaWxzWyd1dWlkJ10gPSB0aGlzLm5Mb2NhbFN0b3JhZ2VTZXJ2aWNlLmdldFZhbHVlKCd1dWlkJyk7XG4gICAgcmV0dXJuIGh0dHAucG9zdChyZWZyZXNoVXJsLCBib2R5KTtcbiAgfVxuXG5cbiAgLyoqXG4gICAqIFJlcXVlc3Qgb3B0aW9ucy5cbiAgICogQHBhcmFtIG9wdGlvbnNcbiAgICogQHJldHVybnMgSHR0cFJlcXVlc3RcbiAgICovXG4gIHByaXZhdGUgcmVxdWVzdE9wdGlvbnMocmVxPzogSHR0cFJlcXVlc3Q8YW55Pikge1xuICAgIGxldCBoZWFkZXJzID0gcmVxLmhlYWRlcnM7XG4gICAgaWYgKHJlcS5oZWFkZXJzID09IG51bGwpIHtcbiAgICAgIGhlYWRlcnMgPSBuZXcgSHR0cEhlYWRlcnMoKTtcbiAgICB9XG4gICAgcmVxID0gcmVxLmNsb25lKHtcbiAgICAgIHVybDogdGhpcy5nZXRGdWxsVXJsKHJlcS51cmwpLFxuICAgICAgaGVhZGVyczogaGVhZGVyc1xuICAgIH0pO1xuICAgIGNvbnN0IGJhc2VVcmwgPSBOU3lzdGVtU2VydmljZS5nZXRJbnN0YW5jZSgpLmdldFZhbCgnYmFzZVVybCcpO1xuICAgIGNvbnN0IGlzQXJ0ID0gKGJhc2VVcmwgIT09ICcnICYmIHJlcS51cmwuaW5jbHVkZXMoYmFzZVVybCkpO1xuICAgIHJldHVybiBpc0FydCA/IHRoaXMuYWRkRGVmYXVsdEhlYWRlcnMocmVxKSA6IHJlcTtcbiAgfVxuXG5cbiAgLyoqXG4gICogRGVmYXVsdCBvcHRpb25zLlxuICAqIEBwYXJhbSBvcHRpb25zXG4gICogQHJldHVybnMgSHR0cEhlYWRlZHJzXG4gICovXG4gIHByaXZhdGUgYWRkRGVmYXVsdEhlYWRlcnMocmVxOiBhbnkpIHtcbiAgICAvKipcbiAgICAgKiBUT0RPOiBBZGQgYWxsIGRlZmF1bHQgSGVhZGVycyBvdmVyIGhlcmVcbiAgICAgKi9cbiAgICBpZiAoIXJlcS5oZWFkZXJzLmhhcygnQWNjZXNzLUNvbnRyb2wtQWxsb3ctT3JpZ2luJykpIHtcbiAgICAgIHJlcS5oZWFkZXJzID0gcmVxLmhlYWRlcnMuc2V0KCdBY2Nlc3MtQ29udHJvbC1BbGxvdy1PcmlnaW4nLCAnKicpO1xuICAgIH1cblxuICAgIGlmICghcmVxLmhlYWRlcnMuaGFzKCdDb250ZW50LVR5cGUnKSkge1xuICAgICAgcmVxLmhlYWRlcnMgPSByZXEuaGVhZGVycy5zZXQoJ0NvbnRlbnQtVHlwZScsICdhcHBsaWNhdGlvbi9qc29uJyk7XG4gICAgfSBlbHNlIGlmIChyZXEuaGVhZGVycy5oYXMoJ0NvbnRlbnQtVHlwZScpICYmIChyZXEuaGVhZGVycy5nZXQoJ0NvbnRlbnQtVHlwZScpID09PSAnbm8tY29udGVudCcpKSB7XG4gICAgICByZXEuaGVhZGVycyA9IHJlcS5oZWFkZXJzLmRlbGV0ZSgnQ29udGVudC1UeXBlJyk7XG4gICAgfVxuXG4gICAgaWYgKCFyZXEuaGVhZGVycy5oYXMoJ0FjY2VwdCcpKSB7XG4gICAgICByZXEuaGVhZGVycyA9IHJlcS5oZWFkZXJzLnNldCgnQWNjZXB0JywgJ2FwcGxpY2F0aW9uL2pzb24nKTtcbiAgICB9XG5cbiAgICBpZiAoIXJlcS5oZWFkZXJzLmhhcygnQXV0aG9yaXphdGlvbicpKSB7XG4gICAgICB0aGlzLmFwcFByb3BlcnRpZXMgPSB0aGlzLnN5c3RlbVNlcnZpY2UuZ2V0VmFsKCdwcm9wZXJ0aWVzJyk7XG4gICAgICBpZiAodGhpcy5hcHBQcm9wZXJ0aWVzICYmIHRoaXMuYXBwUHJvcGVydGllcy5hcHBBdXRoZW50aWNhdGlvblN0cmF0ZWd5ID09PSAnYmFzaWNBdXRoJykge1xuICAgICAgICBsZXQgdXNlcm5hbWUsIHBhc3N3b3JkO1xuICAgICAgICBpZiAodGhpcy5hcHBQcm9wZXJ0aWVzLmJhc2ljQXV0aFVzZXIgJiYgdGhpcy5hcHBQcm9wZXJ0aWVzLmJhc2ljQXV0aFBhc3N3b3JkKSB7XG4gICAgICAgICAgdXNlcm5hbWUgPSB0aGlzLmFwcFByb3BlcnRpZXMuYmFzaWNBdXRoVXNlcjtcbiAgICAgICAgICBwYXNzd29yZCA9IHRoaXMuYXBwUHJvcGVydGllcy5iYXNpY0F1dGhQYXNzd29yZDtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB1c2VybmFtZSA9IFwiYmhpdmUtYXJ0LXByb3h5dXNlclwiO1xuICAgICAgICAgIHBhc3N3b3JkID0gXCJwYXNzd29yZFwiO1xuICAgICAgICAgIGNvbnNvbGUud2FybihcIkF1dGhlbnRpY2F0aW9uIHN0cmF0ZWd5OiBCYXNpYyBBdXRoLiBiYXNpY0F1dGhVc2VyIGFuZCBiYXNpY0F1dGhQYXNzd29yZCBhcmUgbm90IGNvbmZpZ3VyZWQgaW4gZW52aXJvbm1lbnQuIFNldHRpbmcgZGVmYXVsdCB2YWx1ZXMuXCIpO1xuICAgICAgICB9XG4gICAgICAgIHJlcS5oZWFkZXJzID0gcmVxLmhlYWRlcnMuc2V0KCdBdXRob3JpemF0aW9uJywgJ0Jhc2ljICcgKyBidG9hKHVzZXJuYW1lICsgXCI6XCIgKyBwYXNzd29yZCkpO1xuICAgICAgfSBlbHNlIGlmICh0aGlzLmFwcFByb3BlcnRpZXMgJiYgKHRoaXMuYXBwUHJvcGVydGllcy5hcHBBdXRoZW50aWNhdGlvblN0cmF0ZWd5ID09PSAnYWN0aXZlRGlyZWN0b3J5JyB8fFxuICAgICAgICB0aGlzLmFwcFByb3BlcnRpZXMuYXBwQXV0aGVudGljYXRpb25TdHJhdGVneSA9PT0gJ2xvY2FsQXV0aCcpKSB7XG4gICAgICAgIGlmICh0aGlzLm5TZXNzaW9uU3RvcmFnZS5nZXRWYWx1ZSgnYWNjZXNzVG9rZW4nKSkge1xuICAgICAgICAgIHJlcS5oZWFkZXJzID0gcmVxLmhlYWRlcnMuc2V0KCdBdXRob3JpemF0aW9uJywgJ0JlYXJlciAnICsgdGhpcy5uU2Vzc2lvblN0b3JhZ2UuZ2V0VmFsdWUoJ2FjY2Vzc1Rva2VuJykpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiByZXE7XG4gIH1cblxuICAvKipcbiAgICogQnVpbGQgQVBJIHVybC5cbiAgICogQHBhcmFtIHVybFxuICAgKiBAcmV0dXJucyBzdHJpbmdcbiAgICovXG4gIHByaXZhdGUgZ2V0RnVsbFVybCh1cmw6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgLy8gcmV0dXJuIGZ1bGwgVVJMIHRvIEFQSSBoZXJlXG4gICAgcmV0dXJuIHVybDtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXF1ZXN0IGludGVyY2VwdG9yLlxuICAgKi9cbiAgcHJpdmF0ZSByZXF1ZXN0SW50ZXJjZXB0b3IoKTogdm9pZCB7XG4gICAgdGhpcy5uSFRUUExvYWRlci5pc0hUVFBSZXF1ZXN0SW5Qcm9ncmVzcyh0cnVlKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXNwb25zZSBpbnRlcmNlcHRvci5cbiAgICovXG4gIHByaXZhdGUgcmVzcG9uc2VJbnRlcmNlcHRvcigpOiB2b2lkIHtcbiAgICB0aGlzLm5IVFRQTG9hZGVyLmlzSFRUUFJlcXVlc3RJblByb2dyZXNzKGZhbHNlKTtcbiAgfVxuXG4gIC8qKlxuICAgICogRXJyb3IgaGFuZGxlci5cbiAgICAqIEBwYXJhbSBlcnJvclxuICAgICogQHBhcmFtIGNhdWdodFxuICAgICogQHJldHVybnMgRXJyb3JPYnNlcnZhYmxlXG4gICAgKi9cbiAgcHJpdmF0ZSBvbkNhdGNoKGVycm9yOiBIdHRwRXJyb3JSZXNwb25zZSwgcmVxOiBIdHRwUmVxdWVzdDxhbnk+LCBuZXh0OiBIdHRwSGFuZGxlcik6IE9ic2VydmFibGU8YW55PiB7XG4gICAgaWYgKGVycm9yIGluc3RhbmNlb2YgSHR0cEVycm9yUmVzcG9uc2UpIHtcbiAgICAgIGlmICgoPEh0dHBFcnJvclJlc3BvbnNlPmVycm9yKS5zdGF0dXMgPT09IDQwMyAmJiAoPEh0dHBFcnJvclJlc3BvbnNlPmVycm9yKS5lcnJvci5tZXNzYWdlID09PSAnand0IGV4cGlyZWQnKSB7XG4gICAgICAgIHJldHVybiB0aGlzLnVwZGF0ZVRva2VuKGVycm9yLCByZXEsIG5leHQpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIHRoaXMub25TdWJzY3JpYmVFcnJvcihlcnJvcik7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiB0aGlzLm9uU3Vic2NyaWJlRXJyb3IoZXJyb3IpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBvblN1YnNjcmliZUVycm9yXG4gICAqIEBwYXJhbSBlcnJvclxuICAgKi9cbiAgcHJpdmF0ZSBvblN1YnNjcmliZUVycm9yKGVycjogSHR0cEVycm9yUmVzcG9uc2UpOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgIHRoaXMubkhUVFBMb2FkZXIuYWxlcnRFcnJvcihlcnIpO1xuICAgIHJldHVybiB0aGlzLm9uQ2F0Y2hFcnJvcihlcnIpO1xuICB9XG4gIC8qKlxuICAgKiBvbkZpbmFsbHlcbiAgICovXG4gIHByaXZhdGUgb25GaW5hbGx5KCk6IHZvaWQge1xuICAgIHRoaXMucmVzcG9uc2VJbnRlcmNlcHRvcigpO1xuICB9XG5cbiAgcHJpdmF0ZSBvbkNhdGNoRXJyb3IoZXJyb3I6IEh0dHBFcnJvclJlc3BvbnNlKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICByZXR1cm4gdGhyb3dFcnJvcihlcnJvcik7XG4gIH1cblxufVxuIl19