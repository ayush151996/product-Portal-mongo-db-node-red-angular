import * as tslib_1 from "tslib";
import { Component, EventEmitter, Input, Output } from '@angular/core';
import { NSnackbarService } from '../../n-snackbar.service';
let SnackbarComponent = class SnackbarComponent {
    constructor(snackbarService) {
        this.snackbarService = snackbarService;
        this.max = 1;
        this.onAdd = new EventEmitter();
        this.onRemove = new EventEmitter();
        this.onClear = new EventEmitter();
        this.snacks = [];
        this.snackbarService.get()
            .subscribe(snack => {
            if (snack.action === 'add') {
                this.add(snack.data);
            }
            else if (snack.action === 'remove') {
                this.remove(snack.id);
            }
            else if (snack.action === 'clear') {
                this.clear();
            }
        });
    }
    add(snack) {
        let timeout;
        const id = this.uuid();
        if (this.max && this.max > 0 && this.snacks.length === this.max) {
            this.remove(this.snacks[0].id);
        }
        if (snack.timeout || this.timeout) {
            timeout = setTimeout(() => {
                this.remove(id);
            }, snack.timeout || this.timeout);
        }
        const data = Object.assign({ id: id, timeoutObj: timeout }, snack);
        if (snack.action) {
            const that = this;
            const fcn = snack.action.onClick || new Function();
            snack.action.onClick = () => {
                fcn(data);
                that.remove(id);
            };
        }
        if (snack.onAdd) {
            snack.onAdd(data);
        }
        if (this.onAdd) {
            this.onAdd.emit(data);
        }
        this.snacks.push(data);
    }
    remove(id) {
        const snack = this.snacks.find(obj => obj.id === id);
        if (snack) {
            if (snack.onRemove) {
                snack.onRemove(snack);
            }
            if (this.onRemove) {
                this.onRemove.emit(snack);
            }
            if (snack.timeoutObj) {
                clearTimeout(snack.timeoutObj);
            }
        }
        this.snacks = this.snacks.filter(obj => obj.id !== id);
    }
    clear() {
        // this.snacks.forEach(snack => {
        //   this.remove(snack.id);
        // });
        this.snacks = [];
        if (this.onClear) {
            this.onClear.emit(true);
        }
    }
    uuid() {
        // tslint:disable:no-bitwise
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
            const r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        });
        // tslint:enable:no-bitwise
    }
    calcTextColor(background) {
        if (!background) {
            return null;
        }
        function hexToRgb(hex) {
            const shorthandRegex = /^#?([a-f\d])([a-f\d])([a-f\d])$/i;
            hex = hex.replace(shorthandRegex, (m, r, g, b) => {
                return r + r + g + g + b + b;
            });
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? {
                r: parseInt(result[1], 16),
                g: parseInt(result[2], 16),
                b: parseInt(result[3], 16)
            } : null;
        }
        const rgb = hexToRgb(background);
        if (!rgb) {
            return null;
        }
        const color = [rgb.r / 255, rgb.g / 255, rgb.b / 255];
        for (let i = 0; i < color.length; ++i) {
            if (color[i] <= 0.03928) {
                color[i] = color[i] / 12.92;
            }
            else {
                color[i] = Math.pow((color[i] + 0.055) / 1.055, 2.4);
            }
        }
        const l = 0.2126 * color[0] + 0.7152 * color[1] + 0.0722 * color[2];
        if (l > 0.179) {
            return '#000';
        }
        else {
            return '#fff';
        }
    }
};
tslib_1.__decorate([
    Input(),
    tslib_1.__metadata("design:type", String)
], SnackbarComponent.prototype, "position", void 0);
tslib_1.__decorate([
    Input(),
    tslib_1.__metadata("design:type", Number)
], SnackbarComponent.prototype, "max", void 0);
tslib_1.__decorate([
    Input(),
    tslib_1.__metadata("design:type", String)
], SnackbarComponent.prototype, "background", void 0);
tslib_1.__decorate([
    Input(),
    tslib_1.__metadata("design:type", String)
], SnackbarComponent.prototype, "accent", void 0);
tslib_1.__decorate([
    Input(),
    tslib_1.__metadata("design:type", String)
], SnackbarComponent.prototype, "color", void 0);
tslib_1.__decorate([
    Input(),
    tslib_1.__metadata("design:type", Object)
], SnackbarComponent.prototype, "customClass", void 0);
tslib_1.__decorate([
    Input(),
    tslib_1.__metadata("design:type", Number)
], SnackbarComponent.prototype, "timeout", void 0);
tslib_1.__decorate([
    Output(),
    tslib_1.__metadata("design:type", EventEmitter)
], SnackbarComponent.prototype, "onAdd", void 0);
tslib_1.__decorate([
    Output(),
    tslib_1.__metadata("design:type", EventEmitter)
], SnackbarComponent.prototype, "onRemove", void 0);
tslib_1.__decorate([
    Output(),
    tslib_1.__metadata("design:type", EventEmitter)
], SnackbarComponent.prototype, "onClear", void 0);
SnackbarComponent = tslib_1.__decorate([
    Component({
        selector: 'n-snackbar',
        template: `
      <div class="snackbars" [ngClass]="position || 'bottom-center'">
          <n-snack   *ngFor="let snackbar of snacks" [background]="snackbar.background || background"
                        [customClass]="snackbar.customClass || customClass"
                        [color]="snackbar.color || color || calcTextColor(snackbar.background || background)">
              <div class="container">
              <div class="snack-text child" >
                  {{snackbar.msg}}
              </div>
              <div *ngIf="snackbar.action.text" class="snack-action" (click)="snackbar.action.onClick()"
                   [ngStyle]="{color: snackbar.action.color || accent}">
                  {{snackbar.action.text}}
              </div>
              </div>
          </n-snack>
      </div>
  `,
        styles: [".snack-action{cursor:pointer;color:#2196f3;font-weight:700}.container{display:flex;flex-direction:row;flex-wrap:wrap}.child{width:60%;flex:1 0;margin-right:.5em}.snackbars.bottom-center{align-items:middle;left:50%;transform:translate(-50%,0);bottom:1px;align-items:center}.snackbars{position:fixed;z-index:99999;max-width:100%;word-wrap:break-word;display:inline;font-family:Roboto;letter-spacing:1px}.snack{padding:1em;border-radius:.3em;max-height:50vh;overflow:auto}"]
    }),
    tslib_1.__metadata("design:paramtypes", [NSnackbarService])
], SnackbarComponent);
export { SnackbarComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic25hY2tiYXIuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6Im5nOi8vbmV1dHJpbm9zLXNlZWQtc2VydmljZXMvIiwic291cmNlcyI6WyJzcmMvYXBwL25ldXRyaW5vcy1zZWVkLXNlcnZpY2VzL3NuYWNrYmFyL3NuYWNrYmFyL3NuYWNrYmFyLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFNBQVMsRUFBRSxZQUFZLEVBQUUsS0FBSyxFQUFFLE1BQU0sRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUN2RSxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQXVCNUQsSUFBYSxpQkFBaUIsR0FBOUIsTUFBYSxpQkFBaUI7SUFtQjVCLFlBQW9CLGVBQWlDO1FBQWpDLG9CQUFlLEdBQWYsZUFBZSxDQUFrQjtRQWpCNUMsUUFBRyxHQUFXLENBQUMsQ0FBQztRQU9SLFVBQUssR0FBc0IsSUFBSSxZQUFZLEVBQU8sQ0FBQztRQUNuRCxhQUFRLEdBQXNCLElBQUksWUFBWSxFQUFPLENBQUM7UUFDdEQsWUFBTyxHQUEwQixJQUFJLFlBQVksRUFBVyxDQUFDO1FBRTlFLFdBQU0sR0FJRCxFQUFFLENBQUM7UUFHTixJQUFJLENBQUMsZUFBZSxDQUFDLEdBQUcsRUFBRTthQUN2QixTQUFTLENBQUMsS0FBSyxDQUFDLEVBQUU7WUFDakIsSUFBSSxLQUFLLENBQUMsTUFBTSxLQUFLLEtBQUssRUFBRTtnQkFDMUIsSUFBSSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUM7YUFDdEI7aUJBQU0sSUFBSSxLQUFLLENBQUMsTUFBTSxLQUFLLFFBQVEsRUFBRTtnQkFDcEMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLENBQUM7YUFDdkI7aUJBQU0sSUFBSSxLQUFLLENBQUMsTUFBTSxLQUFLLE9BQU8sRUFBRTtnQkFDbkMsSUFBSSxDQUFDLEtBQUssRUFBRSxDQUFDO2FB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OzhDQUFpQjtBQUNoQjtJQUFSLEtBQUssRUFBRTs7cURBQW9CO0FBQ25CO0lBQVIsS0FBSyxFQUFFOztpREFBZ0I7QUFDZjtJQUFSLEtBQUssRUFBRTs7Z0RBQWU7QUFDZDtJQUFSLEtBQUssRUFBRTs7c0RBQWtCO0FBQ2pCO0lBQVIsS0FBSyxFQUFFOztrREFBaUI7QUFFZjtJQUFULE1BQU0sRUFBRTtzQ0FBZSxZQUFZO2dEQUFnQztBQUMxRDtJQUFULE1BQU0sRUFBRTtzQ0FBa0IsWUFBWTttREFBZ0M7QUFDN0Q7SUFBVCxNQUFNLEVBQUU7c0NBQWlCLFlBQVk7a0RBQXdDO0FBWG5FLGlCQUFpQjtJQXJCN0IsU0FBUyxDQUFDO1FBQ1QsUUFBUSxFQUFFLFlBQVk7UUFDdEIsUUFBUSxFQUFFOzs7Ozs7Ozs7Ozs7Ozs7O0dBZ0JUOztLQUVGLENBQUM7NkNBb0JxQyxnQkFBZ0I7R0FuQjFDLGlCQUFpQixDQXVKN0I7U0F2SlksaUJBQWlCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29tcG9uZW50LCBFdmVudEVtaXR0ZXIsIElucHV0LCBPdXRwdXQgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IE5TbmFja2JhclNlcnZpY2UgfSBmcm9tICcuLi8uLi9uLXNuYWNrYmFyLnNlcnZpY2UnO1xuXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICduLXNuYWNrYmFyJyxcbiAgdGVtcGxhdGU6IGBcbiAgICAgIDxkaXYgY2xhc3M9XCJzbmFja2JhcnNcIiBbbmdDbGFzc109XCJwb3NpdGlvbiB8fCAnYm90dG9tLWNlbnRlcidcIj5cbiAgICAgICAgICA8bi1zbmFjayAgICpuZ0Zvcj1cImxldCBzbmFja2JhciBvZiBzbmFja3NcIiBbYmFja2dyb3VuZF09XCJzbmFja2Jhci5iYWNrZ3JvdW5kIHx8IGJhY2tncm91bmRcIlxuICAgICAgICAgICAgICAgICAgICAgICAgW2N1c3RvbUNsYXNzXT1cInNuYWNrYmFyLmN1c3RvbUNsYXNzIHx8IGN1c3RvbUNsYXNzXCJcbiAgICAgICAgICAgICAgICAgICAgICAgIFtjb2xvcl09XCJzbmFja2Jhci5jb2xvciB8fCBjb2xvciB8fCBjYWxjVGV4dENvbG9yKHNuYWNrYmFyLmJhY2tncm91bmQgfHwgYmFja2dyb3VuZClcIj5cbiAgICAgICAgICAgICAgPGRpdiBjbGFzcz1cImNvbnRhaW5lclwiPlxuICAgICAgICAgICAgICA8ZGl2IGNsYXNzPVwic25hY2stdGV4dCBjaGlsZFwiID5cbiAgICAgICAgICAgICAgICAgIHt7c25hY2tiYXIubXNnfX1cbiAgICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgICAgICAgIDxkaXYgKm5nSWY9XCJzbmFja2Jhci5hY3Rpb24udGV4dFwiIGNsYXNzPVwic25hY2stYWN0aW9uXCIgKGNsaWNrKT1cInNuYWNrYmFyLmFjdGlvbi5vbkNsaWNrKClcIlxuICAgICAgICAgICAgICAgICAgIFtuZ1N0eWxlXT1cIntjb2xvcjogc25hY2tiYXIuYWN0aW9uLmNvbG9yIHx8IGFjY2VudH1cIj5cbiAgICAgICAgICAgICAgICAgIHt7c25hY2tiYXIuYWN0aW9uLnRleHR9fVxuICAgICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgICAgPC9uLXNuYWNrPlxuICAgICAgPC9kaXY+XG4gIGAsXG4gIHN0eWxlVXJsczogWycuL3NuYWNrYmFyLnN0eWxlLmNzcyddXG59KVxuZXhwb3J0IGNsYXNzIFNuYWNrYmFyQ29tcG9uZW50IHtcbiAgQElucHV0KCkgcG9zaXRpb246ICd0b3AtbGVmdCcgfCAndG9wLWNlbnRlcicgfCAndG9wLXJpZ2h0JyB8ICdib3R0b20tbGVmdCcgfCAnYm90dG9tLWNlbnRlcicgfCAnYm90dG9tLXJpZ2h0JztcbiAgQElucHV0KCkgbWF4OiBudW1iZXIgPSAxO1xuICBASW5wdXQoKSBiYWNrZ3JvdW5kOiBzdHJpbmc7XG4gIEBJbnB1dCgpIGFjY2VudDogc3RyaW5nO1xuICBASW5wdXQoKSBjb2xvcjogc3RyaW5nO1xuICBASW5wdXQoKSBjdXN0b21DbGFzczogYW55O1xuICBASW5wdXQoKSB0aW1lb3V0OiBudW1iZXI7XG5cbiAgQE91dHB1dCgpIHB1YmxpYyBvbkFkZDogRXZlbnRFbWl0dGVyPGFueT4gPSBuZXcgRXZlbnRFbWl0dGVyPGFueT4oKTtcbiAgQE91dHB1dCgpIHB1YmxpYyBvblJlbW92ZTogRXZlbnRFbWl0dGVyPGFueT4gPSBuZXcgRXZlbnRFbWl0dGVyPGFueT4oKTtcbiAgQE91dHB1dCgpIHB1YmxpYyBvbkNsZWFyOiBFdmVudEVtaXR0ZXI8Ym9vbGVhbj4gPSBuZXcgRXZlbnRFbWl0dGVyPGJvb2xlYW4+KCk7XG5cbiAgc25hY2tzOiBBcnJheTx7XG4gICAgaWQ6IHN0cmluZywgbXNnOiBzdHJpbmcsIHRpbWVvdXQ/OiBudW1iZXIsIGNvbG9yPzogc3RyaW5nLCBiYWNrZ3JvdW5kPzogc3RyaW5nLCBjdXN0b21DbGFzcz86IGFueSwgYWN0aW9uPzoge1xuICAgICAgdGV4dDogc3RyaW5nLCBvbkNsaWNrPzogRnVuY3Rpb24sIGNvbG9yPzogc3RyaW5nXG4gICAgfSwgb25BZGQ/OiBGdW5jdGlvbiwgb25SZW1vdmU/OiBGdW5jdGlvbiwgdGltZW91dE9iaj86IGFueVxuICB9PiA9IFtdO1xuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgc25hY2tiYXJTZXJ2aWNlOiBOU25hY2tiYXJTZXJ2aWNlKSB7XG4gICAgdGhpcy5zbmFja2JhclNlcnZpY2UuZ2V0KClcbiAgICAgIC5zdWJzY3JpYmUoc25hY2sgPT4ge1xuICAgICAgICBpZiAoc25hY2suYWN0aW9uID09PSAnYWRkJykge1xuICAgICAgICAgIHRoaXMuYWRkKHNuYWNrLmRhdGEpO1xuICAgICAgICB9IGVsc2UgaWYgKHNuYWNrLmFjdGlvbiA9PT0gJ3JlbW92ZScpIHtcbiAgICAgICAgICB0aGlzLnJlbW92ZShzbmFjay5pZCk7XG4gICAgICAgIH0gZWxzZSBpZiAoc25hY2suYWN0aW9uID09PSAnY2xlYXInKSB7XG4gICAgICAgICAgdGhpcy5jbGVhcigpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgfVxuXG4gIGFkZChzbmFjaykge1xuICAgIGxldCB0aW1lb3V0O1xuICAgIGNvbnN0IGlkID0gdGhpcy51dWlkKCk7XG5cbiAgICBpZiAodGhpcy5tYXggJiYgdGhpcy5tYXggPiAwICYmIHRoaXMuc25hY2tzLmxlbmd0aCA9PT0gdGhpcy5tYXgpIHtcbiAgICAgIHRoaXMucmVtb3ZlKHRoaXMuc25hY2tzWzBdLmlkKTtcbiAgICB9XG5cbiAgICBpZiAoc25hY2sudGltZW91dCB8fCB0aGlzLnRpbWVvdXQpIHtcbiAgICAgIHRpbWVvdXQgPSBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgdGhpcy5yZW1vdmUoaWQpO1xuICAgICAgfSwgc25hY2sudGltZW91dCB8fCB0aGlzLnRpbWVvdXQpXG4gICAgfVxuXG4gICAgY29uc3QgZGF0YSA9IE9iamVjdC5hc3NpZ24oeyBpZDogaWQsIHRpbWVvdXRPYmo6IHRpbWVvdXQgfSwgc25hY2spO1xuXG4gICAgaWYgKHNuYWNrLmFjdGlvbikge1xuICAgICAgY29uc3QgdGhhdCA9IHRoaXM7XG4gICAgICBjb25zdCBmY24gPSBzbmFjay5hY3Rpb24ub25DbGljayB8fCBuZXcgRnVuY3Rpb24oKTtcbiAgICAgIHNuYWNrLmFjdGlvbi5vbkNsaWNrID0gKCkgPT4ge1xuICAgICAgICBmY24oZGF0YSk7XG4gICAgICAgIHRoYXQucmVtb3ZlKGlkKTtcbiAgICAgIH07XG4gICAgfVxuXG4gICAgaWYgKHNuYWNrLm9uQWRkKSB7XG4gICAgICBzbmFjay5vbkFkZChkYXRhKTtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5vbkFkZCkge1xuICAgICAgdGhpcy5vbkFkZC5lbWl0KGRhdGEpO1xuICAgIH1cblxuICAgIHRoaXMuc25hY2tzLnB1c2goZGF0YSk7XG4gIH1cblxuICByZW1vdmUoaWQpIHtcbiAgICBjb25zdCBzbmFjayA9IHRoaXMuc25hY2tzLmZpbmQob2JqID0+IG9iai5pZCA9PT0gaWQpO1xuXG4gICAgaWYgKHNuYWNrKSB7XG4gICAgICBpZiAoc25hY2sub25SZW1vdmUpIHtcbiAgICAgICAgc25hY2sub25SZW1vdmUoc25hY2spO1xuICAgICAgfVxuXG4gICAgICBpZiAodGhpcy5vblJlbW92ZSkge1xuICAgICAgICB0aGlzLm9uUmVtb3ZlLmVtaXQoc25hY2spO1xuICAgICAgfVxuXG4gICAgICBpZiAoc25hY2sudGltZW91dE9iaikge1xuICAgICAgICBjbGVhclRpbWVvdXQoc25hY2sudGltZW91dE9iaik7XG4gICAgICB9XG4gICAgfVxuXG4gICAgdGhpcy5zbmFja3MgPSB0aGlzLnNuYWNrcy5maWx0ZXIob2JqID0+IG9iai5pZCAhPT0gaWQpO1xuICB9XG5cbiAgY2xlYXIoKSB7XG4gICAgLy8gdGhpcy5zbmFja3MuZm9yRWFjaChzbmFjayA9PiB7XG4gICAgLy8gICB0aGlzLnJlbW92ZShzbmFjay5pZCk7XG4gICAgLy8gfSk7XG5cbiAgICB0aGlzLnNuYWNrcyA9IFtdO1xuXG4gICAgaWYgKHRoaXMub25DbGVhcikge1xuICAgICAgdGhpcy5vbkNsZWFyLmVtaXQodHJ1ZSk7XG4gICAgfVxuICB9XG5cbiAgdXVpZCgpIHtcbiAgICAvLyB0c2xpbnQ6ZGlzYWJsZTpuby1iaXR3aXNlXG4gICAgcmV0dXJuICd4eHh4eHh4eC14eHh4LTR4eHgteXh4eC14eHh4eHh4eHh4eHgnLnJlcGxhY2UoL1t4eV0vZywgZnVuY3Rpb24gKGMpIHtcbiAgICAgIGNvbnN0IHIgPSBNYXRoLnJhbmRvbSgpICogMTYgfCAwLCB2ID0gYyA9PT0gJ3gnID8gciA6IChyICYgMHgzIHwgMHg4KTtcbiAgICAgIHJldHVybiB2LnRvU3RyaW5nKDE2KTtcbiAgICB9KTtcbiAgICAvLyB0c2xpbnQ6ZW5hYmxlOm5vLWJpdHdpc2VcbiAgfVxuXG4gIGNhbGNUZXh0Q29sb3IoYmFja2dyb3VuZCkge1xuICAgIGlmICghYmFja2dyb3VuZCkge1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG4gICAgZnVuY3Rpb24gaGV4VG9SZ2IoaGV4KSB7XG4gICAgICBjb25zdCBzaG9ydGhhbmRSZWdleCA9IC9eIz8oW2EtZlxcZF0pKFthLWZcXGRdKShbYS1mXFxkXSkkL2k7XG4gICAgICBoZXggPSBoZXgucmVwbGFjZShzaG9ydGhhbmRSZWdleCwgKG0sIHIsIGcsIGIpID0+IHtcbiAgICAgICAgcmV0dXJuIHIgKyByICsgZyArIGcgKyBiICsgYjtcbiAgICAgIH0pO1xuXG4gICAgICBjb25zdCByZXN1bHQgPSAvXiM/KFthLWZcXGRdezJ9KShbYS1mXFxkXXsyfSkoW2EtZlxcZF17Mn0pJC9pLmV4ZWMoaGV4KTtcbiAgICAgIHJldHVybiByZXN1bHQgPyB7XG4gICAgICAgIHI6IHBhcnNlSW50KHJlc3VsdFsxXSwgMTYpLFxuICAgICAgICBnOiBwYXJzZUludChyZXN1bHRbMl0sIDE2KSxcbiAgICAgICAgYjogcGFyc2VJbnQocmVzdWx0WzNdLCAxNilcbiAgICAgIH0gOiBudWxsO1xuICAgIH1cblxuICAgIGNvbnN0IHJnYiA9IGhleFRvUmdiKGJhY2tncm91bmQpO1xuICAgIGlmICghcmdiKSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICBjb25zdCBjb2xvciA9IFtyZ2IuciAvIDI1NSwgcmdiLmcgLyAyNTUsIHJnYi5iIC8gMjU1XTtcblxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgY29sb3IubGVuZ3RoOyArK2kpIHtcbiAgICAgIGlmIChjb2xvcltpXSA8PSAwLjAzOTI4KSB7XG4gICAgICAgIGNvbG9yW2ldID0gY29sb3JbaV0gLyAxMi45MjtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbG9yW2ldID0gTWF0aC5wb3coKGNvbG9yW2ldICsgMC4wNTUpIC8gMS4wNTUsIDIuNCk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgY29uc3QgbCA9IDAuMjEyNiAqIGNvbG9yWzBdICsgMC43MTUyICogY29sb3JbMV0gKyAwLjA3MjIgKiBjb2xvclsyXTtcblxuICAgIGlmIChsID4gMC4xNzkpIHtcbiAgICAgIHJldHVybiAnIzAwMCc7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiAnI2ZmZic7XG4gICAgfVxuICB9XG59XG4iXX0=